<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>AppSheet API - Lọc dữ liệu từ URL</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
    h2 { color: #333; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    th { background: #4CAF50; color: white; }
    #loading { font-size: 18px; color: #666; margin: 20px 0; }
    .filter-info { background: #e7f3ff; padding: 10px; border-radius: 5px; margin-bottom: 15px; }
  </style>
</head>
<body>

<h2>Dữ liệu trực SR - AppSheet (lọc từ URL)</h2>

<div id="filterInfo" class="filter-info" style="display:none;">
  <strong>Đang lọc theo:</strong> <span id="filterText"></span>
</div>

<div>

<div id="loading">Đang tải dữ liệu...</div>

<table id="dataTable" style="display:none;">
  <thead id="thead"></thead>
  <tbody id="tbody"></tbody>
</table>

<script>
// === CẤU HÌNH ===
const APP_ID = "85c13c41-63da-48b2-9cdd-034cd61f2373";
const TABLE_NAME = "TRUC SR";
const ACCESS_KEY = "V2-r9P4X-JGq69-InVwk-jHWX0-wlkrU-JS3kU-0qrmK-P1tnM";

// Các cột bạn muốn hiển thị
const columnsToShow = ["NGAY", "NVKD", "TEN NVKD", "KHACH HANG", "TRUC", "GHI CHU"];

// Hàm lấy tham số từ URL
function getQueryParams() {
  const params = new URLSearchParams(window.location.search);
  const filters = {};
  
  for (const [key, value] of params) {
    if (value !== "") {
      // Hỗ trợ nhiều giá trị cho cùng 1 key: ?NVKD=A&NVKD=B
      if (filters[key]) {
        if (Array.isArray(filters[key])) {
          filters[key].push(value);
        } else {
          filters[key] = [filters[key], value];
        }
      } else {
        filters[key] = value;
      }
    }
  }
  return filters;
}

// Hàm tạo chuỗi Filter cho AppSheet (dùng AND, hỗ trợ IN cho nhiều giá trị)
function buildFilterExpression(filters) {
  const conditions = [];

  for (const [column, value] of Object.entries(filters)) {
    if (Array.isArray(value)) {
      // Nếu có nhiều giá trị → dùng IN(...)
      const escapedValues = value.map(v => `"${v.replace(/"/g, '\\"')}"`);
      conditions.push(`IN([${column}], {${escapedValues.join(", ")}})`);
    } else {
      // Giá trị đơn
      const escaped = value.replace(/"/g, '\\"');
      conditions.push(`[${column}] = "${escaped}"`);
    }
  }

  return conditions.length > 0 ? conditions.join(" AND ") : "";
}

async function loadData() {
  const url = `https://api.appsheet.com/api/v2/apps/${APP_ID}/tables/${encodeURIComponent(TABLE_NAME)}/Find`;

  // Lấy filter từ URL
  const filters = getQueryParams();
  const filterExpression = buildFilterExpression(filters);

  const body = {
    "Action": "Find",
    "Properties": {},
    "Rows": {}
  };

  // Nếu có filter thì thêm vào
  if (filterExpression) {
    body.Filter = filterExpression;
    // Hiển thị thông tin lọc
    document.getElementById("filterInfo").style.display = "block";
    document.getElementById("filterText").textContent = filterExpression;
  }

  try {
    const res = await fetch(url, {
      method: "POST",
      headers: {
        "ApplicationAccessKey": ACCESS_KEY,
        "Content-Type": "application/json"
      },
      body: JSON.stringify(body)
    });

    if (!res.ok) {
      throw new Error(`HTTP ${res.status}`);
    }

    const raw = await res.json();
    const data = raw.Rows || [];

    document.getElementById("loading").style.display = "none";

    if (data.length === 0) {
      document.getElementById("loading").innerText = "Không tìm thấy dữ liệu phù hợp!";
      document.getElementById("loading").style.color = "red";
      return;
    }

    // Hiển thị bảng
    document.getElementById("dataTable").style.display = "table";

    // Tạo header
    document.getElementById("thead").innerHTML =
      "<tr>" + columnsToShow.map(c => `<th>${c}</th>`).join("") + "</tr>";

    // Tạo body
    document.getElementById("tbody").innerHTML = data.map(row =>
      "<tr>" +
        columnsToShow.map(col => {
          let val = row[col];
          if (val === null || val === undefined) val = "";
          return `<td>${val}</td>`;
        }).join("") +
      "</tr>"
    ).join("");

  } catch (err) {
    console.error("Lỗi:", err);
    document.getElementById("loading").innerHTML = `Lỗi tải dữ liệu: ${err.message}`;
    document.getElementById("loading").style.color = "red";
  }
}

// Chạy khi tải trang
loadData();
</script>

</body>
</html>
