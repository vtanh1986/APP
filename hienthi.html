<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>AppSheet API - Ch·ªçn c·ªôt hi·ªÉn th·ªã</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    .info { background: #e3f2fd; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
    .info h3 { margin-top: 0; color: #1976d2; }
    .info code { background: #fff; padding: 2px 6px; border-radius: 3px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #f0f0f0; }
    #loading { font-size: 18px; color: #555; }
    .filter-info { margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px; }
  </style>
</head>
<body>
<h2>Hi·ªÉn th·ªã d·ªØ li·ªáu AppSheet (l·ªçc qua URL)</h2>

<div class="info">
  <h3>üìù H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</h3>
  <p><strong>C√°ch truy·ªÅn ƒëi·ªÅu ki·ªán l·ªçc qua URL:</strong></p>
  <ul>
    <li><strong>1 ƒëi·ªÅu ki·ªán:</strong><br>
      <code>?NGAY=2024-01-15</code><br>
      <code>?NVKD=NV001</code>
    </li>
    <li><strong>Nhi·ªÅu ƒëi·ªÅu ki·ªán (AND):</strong><br>
      <code>?NGAY=2024-01-15&NVKD=NV001</code><br>
      <code>?NVKD=NV001&TEN_NVKD=Nguyen Van A</code>
    </li>
    <li><strong>So s√°nh:</strong><br>
      <code>?NGAY_gt=2024-01-01</code> (l·ªõn h∆°n)<br>
      <code>?NGAY_lt=2024-12-31</code> (nh·ªè h∆°n)<br>
      <code>?NGAY_gte=2024-01-01&NGAY_lte=2024-12-31</code> (t·ª´...ƒë·∫øn...)
    </li>
  </ul>
  <p><strong>C√°c to√°n t·ª≠ h·ªó tr·ª£:</strong> <code>_eq</code> (b·∫±ng), <code>_gt</code> (l·ªõn h∆°n), <code>_gte</code> (l·ªõn h∆°n ho·∫∑c b·∫±ng), <code>_lt</code> (nh·ªè h∆°n), <code>_lte</code> (nh·ªè h∆°n ho·∫∑c b·∫±ng)</p>
</div>

<div class="filter-info" id="filterInfo">
  <strong>ƒêi·ªÅu ki·ªán l·ªçc hi·ªán t·∫°i:</strong> <span id="currentFilter">Kh√¥ng c√≥</span>
</div>

<div id="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>
<table id="dataTable" style="display:none;">
  <thead id="thead"></thead>
  <tbody id="tbody"></tbody>
</table>

<script>
// H√†m ƒë·ªçc URL parameters v√† t·∫°o filter AppSheet
function buildFilterFromURL() {
  const params = new URLSearchParams(window.location.search);
  const conditions = [];
  
  params.forEach((value, key) => {
    // X·ª≠ l√Ω c√°c to√°n t·ª≠ so s√°nh
    let operator = "=";
    let column = key;
    
    if (key.endsWith("_gt")) {
      operator = ">";
      column = key.replace("_gt", "");
    } else if (key.endsWith("_gte")) {
      operator = ">=";
      column = key.replace("_gte", "");
    } else if (key.endsWith("_lt")) {
      operator = "<";
      column = key.replace("_lt", "");
    } else if (key.endsWith("_lte")) {
      operator = "<=";
      column = key.replace("_lte", "");
    } else if (key.endsWith("_eq")) {
      operator = "=";
      column = key.replace("_eq", "");
    }
    
    // Th√™m d·∫•u ngo·∫∑c k√©p cho gi√° tr·ªã text
    const formattedValue = isNaN(value) ? `"${value}"` : value;
    conditions.push(`[${column}]${operator}${formattedValue}`);
  });
  
  // N·ªëi c√°c ƒëi·ªÅu ki·ªán b·∫±ng AND
  return conditions.length > 0 ? conditions.join(" AND ") : "";
}

async function loadData() {
  const url = "https://api.appsheet.com/api/v2/apps/85c13c41-63da-48b2-9cdd-034cd61f2373/tables/TRUC%20SR/find";
  const columnsToShow = ["NGAY", "NVKD", "TEN NVKD"];
  
  // T·∫°o filter t·ª´ URL
  const filterExpression = buildFilterFromURL();
  
  // Hi·ªÉn th·ªã filter hi·ªán t·∫°i
  document.getElementById("currentFilter").innerText = filterExpression || "Kh√¥ng c√≥ (hi·ªÉn th·ªã t·∫•t c·∫£)";
  
  const body = {
    "Action": "Find",
    "Filter": filterExpression
  };
  
  console.log("Filter ƒë∆∞·ª£c g·ª≠i:", filterExpression);
  
  try {
    const res = await fetch(url, {
      method: "POST",
      headers: {
        "ApplicationAccessKey": "V2-r9P4X-JGq69-InVwk-jHWX0-wlkrU-JS3kU-0qrmK-P1tnM",
        "Content-Type": "application/json"
      },
      body: JSON.stringify(body)
    });
    
    console.log("Status:", res.status);
    const raw = await res.json();
    console.log("Raw:", raw);
    
    const data = raw.Rows ?? raw;
    console.log("Data d√πng ƒë·ªÉ hi·ªÉn th·ªã:", data);
    
    document.getElementById("loading").style.display = "none";
    
    if (!data || data.length === 0) {
      document.getElementById("loading").innerText = "Kh√¥ng c√≥ d·ªØ li·ªáu ph√π h·ª£p!";
      document.getElementById("loading").style.display = "block";
      return;
    }
    
    document.getElementById("dataTable").style.display = "";
    document.getElementById("thead").innerHTML =
      "<tr>" + columnsToShow.map(c => `<th>${c}</th>`).join("") + "</tr>";
    document.getElementById("tbody").innerHTML =
      data.map(row =>
        "<tr>" +
          columnsToShow.map(c => `<td>${row[c] ?? ""}</td>`).join("") +
        "</tr>"
      ).join("");
  } catch (err) {
    console.error("L·ªói fetch:", err);
    document.getElementById("loading").innerText = "L·ªói: " + err.message;
    document.getElementById("loading").style.display = "block";
  }
}

loadData();
</script>
</body>
</html>
