<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Danh sách hóa đơn</title>
  <style>
    body { font-family: Arial; padding: 20px; background: #f6f6f6; }
    h1 { margin-bottom: 15px; }
    table { width: 100%; border-collapse: collapse; background: white;}
    th, td { border: 1px solid #ddd; padding: 8px; font-size: 14px; }
    th { background: #f0f0f0; }
    .controls { margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; }
    input, button { padding: 6px 8px; }
    button { cursor: pointer; background: #1976d2; color: white; border: none; border-radius: 4px; }
    .stt { text-align: center; width: 50px; }
    .tyleHH { text-align: center; }
    .export-btn { background: #2e7d32; margin-left: auto; }
    .loading { color: #1976d2; font-weight: bold; }
    .error { color: #d32f2f; font-weight: bold; }
  </style>
</head>

<body>
  <h1>Danh sách hóa đơn</h1>

  <!-- Filter controls -->
  <div class="controls">
    <label>Từ ngày <input type="date" id="from"></label>
    <label>Đến ngày <input type="date" id="to"></label>
    <button id="apply">Lọc</button>
    <button id="reset">Xóa</button>
    <button id="exportExcel" class="export-btn">Tải Excel</button>
  </div>

  <div id="status" class="loading">Đang tải dữ liệu...</div>
  <div id="tableWrap"></div>

  <script>
    const DATA_URL = "https://script.google.com/macros/s/AKfycbwnoIs3T8FKrq53SG7lCTwE1Rm0H6eWc05mD1S347XscHkgg-VxMkHO96b_8Z-O_r0j/exec";
    let currentFilteredData = [];

    // -------------------------------
    // Parse date để lấy ngày chuẩn yyyy-mm-dd
    // -------------------------------
    function parseDateToStandard(value) {
      if (!value && value !== 0) return null;

      // Nếu đã là Date object
      if (value instanceof Date) {
        if (isNaN(value)) return null;
        return new Date(value.getFullYear(), value.getMonth(), value.getDate());
      }

      // Số (timestamp)
      if (typeof value === 'number') {
        const d = new Date(value);
        return isNaN(d) ? null : new Date(d.getFullYear(), d.getMonth(), d.getDate());
      }

      const s = String(value).trim();
      
      // yyyy-mm-dd
      let m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
      if (m) {
        const y = Number(m[1]), mo = Number(m[2]) - 1, da = Number(m[3]);
        return new Date(y, mo, da);
      }
      
      // yyyy/mm/dd
      m = s.match(/^(\d{4})\/(\d{1,2})\/(\d{1,2})$/);
      if (m) {
        const y = Number(m[1]), mo = Number(m[2]) - 1, da = Number(m[3]);
        return new Date(y, mo, da);
      }
      
      // dd/mm/yyyy
      m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (m) {
        const da = Number(m[1]), mo = Number(m[2]) - 1, y = Number(m[3]);
        return new Date(y, mo, da);
      }

      // dd-mm-yyyy
      m = s.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/);
      if (m) {
        const da = Number(m[1]), mo = Number(m[2]) - 1, y = Number(m[3]);
        return new Date(y, mo, da);
      }

      // Thử Date constructor cho các định dạng khác
      const d = new Date(s);
      if (!isNaN(d)) {
        return new Date(d.getFullYear(), d.getMonth(), d.getDate());
      }

      return null;
    }

    // -------------------------------
    // Format ngày thành yyyy-mm-dd
    // -------------------------------
    function formatDateToYYYYMMDD(raw) {
      const d = parseDateToStandard(raw);
      if (!d) return raw || ''; // Trả về nguyên bản nếu không parse được
      
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    // -------------------------------
    // Format tỷ lệ HH thành %
    // -------------------------------
    function formatTyLeHH(value) {
      if (value === null || value === undefined || value === '') return '';
      
      // Chuyển thành số
      const num = Number(value);
      if (isNaN(num)) return value;
      
      // Nhân với 100 và làm tròn 1 chữ số thập phân
      const percent = (num * 100).toFixed(1);
      
      // Loại bỏ .0 nếu là số nguyên
      const formatted = percent.replace(/\.0$/, '');
      
      return `${formatted}%`;
    }

    // -------------------------------
    // Xây dựng URL với tham số
    // -------------------------------
    function buildDataURL(fromDate = null, toDate = null) {
      let url = DATA_URL;
      const params = [];
      
      if (fromDate) {
        params.push(`tungay=${encodeURIComponent(formatDateToYYYYMMDD(fromDate))}`);
      }
      
      if (toDate) {
        params.push(`denngay=${encodeURIComponent(formatDateToYYYYMMDD(toDate))}`);
      }
      
      if (params.length > 0) {
        url += '?' + params.join('&');
      }
      
      return url;
    }

    // -------------------------------
    // Tải dữ liệu đã lọc từ Apps Script
    // -------------------------------
    async function loadFilteredData(fromDate = null, toDate = null) {
      try {
        const url = buildDataURL(fromDate, toDate);
        document.getElementById("status").className = "loading";
        document.getElementById("status").textContent = "Đang tải dữ liệu...";
        
        const res = await fetch(url);
        const data = await res.json();
        const filteredData = Array.isArray(data) ? data : (data.rows || []);
        
        // Sắp xếp dữ liệu theo ngày và số hóa đơn giảm dần
        sortData(filteredData);
        
        document.getElementById("status").className = "";
        document.getElementById("status").textContent = "Đã tải " + filteredData.length + " bản ghi.";
        
        // Lưu dữ liệu hiện tại
        currentFilteredData = filteredData;
        
        // Hiển thị bảng
        renderTable(filteredData);
        
      } catch (err) {
        document.getElementById("status").className = "error";
        document.getElementById("status").textContent = "Lỗi tải dữ liệu: " + err;
      }
    }

    // -------------------------------
    // Sắp xếp dữ liệu theo ngày giảm dần, rồi theo số hóa đơn giảm dần
    // -------------------------------
    function sortData(data) {
      data.sort((a, b) => {
        // Lấy ngày xuất hóa đơn
        const dateA = parseDateToStandard(a.ngayXuatHoaDon || a['Ngày xuất'] || a['ngay_xuat'] || a['ngayXuatHoaDon'] || a['ngay'] || a['Ngày']);
        const dateB = parseDateToStandard(b.ngayXuatHoaDon || b['Ngày xuất'] || b['ngay_xuat'] || b['ngayXuatHoaDon'] || b['ngay'] || b['Ngày']);
        
        // Lấy số hóa đơn
        const soHoaDonA = a.soHoaDon || a['Số hóa đơn'] || a['so_hoadon'] || a['sohoadon'] || '';
        const soHoaDonB = b.soHoaDon || b['Số hóa đơn'] || b['so_hoadon'] || b['sohoadon'] || '';
        
        // So sánh ngày trước
        if (dateA && dateB) {
          if (dateA.getTime() !== dateB.getTime()) {
            // Sắp xếp ngày giảm dần (mới nhất trước)
            return dateB.getTime() - dateA.getTime();
          }
        } else if (!dateA && dateB) {
          return 1; // Không có ngày đẩy xuống dưới
        } else if (dateA && !dateB) {
          return -1; // Không có ngày đẩy xuống dưới
        } else if (!dateA && !dateB) {
          // Cả hai đều không có ngày, so sánh số hóa đơn
        }
        
        // Nếu cùng ngày hoặc không có ngày, so sánh số hóa đơn giảm dần
        // Chuyển số hóa đơn thành số để so sánh nếu có thể
        const numA = parseFloat(soHoaDonA);
        const numB = parseFloat(soHoaDonB);
        
        if (!isNaN(numA) && !isNaN(numB)) {
          // So sánh số
          return numB - numA;
        } else {
          // So sánh chuỗi (giảm dần Z->A)
          return soHoaDonB.localeCompare(soHoaDonA);
        }
      });
    }

    // -------------------------------
    // Lấy danh sách cột (bỏ các cột không cần hiển thị)
    // -------------------------------
    function getColumns(data) {
      if (!data || data.length === 0) return ['TT'];
      
      const firstRow = data[0];
      const excludedColumns = [
        'id', 'ID', 'Id',
        'quy', 'Quy', 'QUY',
        'nam', 'Nam', 'NAM',
        'lichsuhoadon', 'LichSuHoaDon', 'LICHSUHOADON', 'lich_su_hoa_don',
        'danhdau', 'DanhDau', 'DANHDAU', 'danh_dau',
        'nguoithuchien', 'NguoiThucHien', 'NGUOITHUCHIEN', 'nguoi_thuc_hien'
      ];
      
      const cols = Object.keys(firstRow).filter(col => {
        const lowerCol = col.toLowerCase();
        return !excludedColumns.some(excluded => 
          lowerCol === excluded.toLowerCase() || 
          col === excluded
        );
      });
      
      // Thêm cột TT vào đầu
      cols.unshift('TT');
      return cols;
    }

    // -------------------------------
    // Hiển thị bảng
    // -------------------------------
    function renderTable(list) {
      if (!list || list.length === 0) {
        document.getElementById("tableWrap").innerHTML = "<p>Không có dữ liệu.</p>";
        return;
      }

      const cols = getColumns(list);
      let html = "<table><thead><tr>" + 
        cols.map(c => {
          if (c === 'TT') return `<th class="stt">${c}</th>`;
          if (c.toLowerCase().includes('tylehh') || c.toLowerCase().includes('tyle_hh')) 
            return `<th class="tyleHH">${c}</th>`;
          return `<th>${c}</th>`;
        })
        .join('') + 
        "</tr></thead><tbody>";

      for (let i = 0; i < list.length; i++) {
        const r = list[i];
        html += "<tr>" + cols.map(c => {
          if (c === 'TT') {
            return `<td class="stt">${i + 1}</td>`;
          }
          
          const value = r[c];
          
          // Format ngày thành yyyy-mm-dd
          if (c.toLowerCase().includes('ngay') || c.toLowerCase().includes('date')) {
            const formatted = formatDateToYYYYMMDD(value);
            return `<td>${formatted}</td>`;
          }
          
          // Format tỷ lệ HH thành %
          if (c.toLowerCase().includes('tylehh') || c.toLowerCase().includes('tyle_hh')) {
            const formatted = formatTyLeHH(value);
            return `<td class="tyleHH">${formatted}</td>`;
          }
          
          // Tiền -> format số
          if (c.toLowerCase().includes('tien') || 
              c.toLowerCase().includes('sotien') || 
              c.toLowerCase().includes('so_tien') || 
              c.toLowerCase().includes('tong') ||
              c.toLowerCase().includes('thanhtien')) {
            const v = value == null ? '' : Number(value);
            return `<td style="text-align:right">${isNaN(v) ? (value ?? '') : v.toLocaleString('vi-VN')}</td>`;
          }
          
          // Hiển thị nguyên bản cho các trường khác
          return `<td>${value ?? ''}</td>`;
        }).join('') + "</tr>";
      }

      html += "</tbody></table>";
      document.getElementById("tableWrap").innerHTML = html;
    }

    // -------------------------------
    // Đọc tham số từ URL và tải dữ liệu
    // -------------------------------
    function applyFiltersFromURL() {
      const params = new URLSearchParams(location.search);
      const tungay = params.get("tungay");
      const denngay = params.get("denngay");

      const from = tungay ? parseDateToStandard(tungay) : null;
      const to = denngay ? parseDateToStandard(denngay) : null;

      // Cập nhật giá trị input
      if (from) document.getElementById("from").value = from.toISOString().slice(0, 10);
      if (to) document.getElementById("to").value = to.toISOString().slice(0, 10);

      // Tải dữ liệu đã lọc
      loadFilteredData(from, to);
    }

    // -------------------------------
    // Export to Excel
    // -------------------------------
    function exportToExcel() {
      if (!currentFilteredData || currentFilteredData.length === 0) {
        alert('Không có dữ liệu để xuất Excel');
        return;
      }

      // Lấy cột hiển thị
      const cols = getColumns(currentFilteredData).filter(c => c !== 'TT');
      
      // Tạo nội dung CSV
      let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
      
      // Header
      const headers = ['TT', ...cols];
      csvContent += headers.join(',') + '\n';
      
      // Data rows
      for (let i = 0; i < currentFilteredData.length; i++) {
        const row = currentFilteredData[i];
        const rowData = [i + 1];
        
        for (const col of cols) {
          let value = row[col] ?? '';
          
          // Format ngày
          if (col.toLowerCase().includes('ngay') || col.toLowerCase().includes('date')) {
            value = formatDateToYYYYMMDD(value);
          }
          
          // Format tỷ lệ HH
          else if (col.toLowerCase().includes('tylehh') || col.toLowerCase().includes('tyle_hh')) {
            value = formatTyLeHH(value);
          }
          
          // Format tiền (loại bỏ dấu phân cách hàng nghìn để Excel hiểu)
          else if (col.toLowerCase().includes('tien') || 
                  col.toLowerCase().includes('sotien') || 
                  col.toLowerCase().includes('so_tien') || 
                  col.toLowerCase().includes('tong') ||
                  col.toLowerCase().includes('thanhtien')) {
            const num = Number(value);
            if (!isNaN(num)) {
              value = num;
            }
          }
          
          // Escape commas and quotes for CSV
          if (typeof value === 'string') {
            if (value.includes(',') || value.includes('"') || value.includes('\n')) {
              value = '"' + value.replace(/"/g, '""') + '"';
            }
          }
          
          rowData.push(value);
        }
        
        csvContent += rowData.join(',') + '\n';
      }
      
      // Tạo và tải file
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", `HoaDon_${new Date().toISOString().slice(0, 10)}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // -------------------------------
    // Buttons
    // -------------------------------
    document.getElementById("apply").onclick = () => {
      const vFrom = document.getElementById("from").value;
      const vTo = document.getElementById("to").value;

      const from = vFrom ? parseDateToStandard(vFrom) : null;
      const to = vTo ? parseDateToStandard(vTo) : null;

      // Update URL and reload with filters
      const p = new URLSearchParams();
      if (from) p.set('tungay', vFrom);
      if (to) p.set('denngay', vTo);
      
      const newUrl = location.pathname + (p.toString() ? '?' + p.toString() : '');
      window.location.href = newUrl;
    };

    document.getElementById("reset").onclick = () => {
      // Reset to no filters
      window.location.href = location.pathname;
    };

    document.getElementById("exportExcel").onclick = exportToExcel;

    // Khởi động - đọc tham số từ URL
    applyFiltersFromURL();
  </script>
</body>
</html>
