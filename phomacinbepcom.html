<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHON IN BEP - XPRINTER K200L</title>
    <style>
        /* Reset v√† font ch·ªØ ƒë∆°n gi·∫£n */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', monospace;
            line-height: 1.2;
            padding: 10px;
            max-width: 500px;
            margin: 0 auto;
            background-color: #fff;
        }
        
        /* Container ch√≠nh */
        .order-container {
            border: 1px solid #000;
            padding: 15px;
            font-size: 14px;
        }
        
        /* Ti√™u ƒë·ªÅ order */
        .order-header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #000;
        }
        
        .order-number {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .table-info {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        /* Th√¥ng tin ƒë∆°n h√†ng */
        .service-name {
            margin-bottom: 15px;
            font-weight: bold;
            text-align: center;
        }
        
        /* Ti√™u ƒë·ªÅ c·ªôt danh s√°ch m√≥n */
        .dish-header {
            display: grid;
            grid-template-columns: 50px 1fr 70px;
            margin-bottom: 5px;
            font-weight: bold;
            padding-bottom: 3px;
            border-bottom: 1px solid #000;
        }
        
        .dish-header > div {
            padding: 0 5px;
        }
        
        /* Danh s√°ch m√≥n ƒÉn */
        .dish-list {
            margin-top: 10px;
        }
        
        .dish-item {
            display: grid;
            grid-template-columns: 50px 1fr 70px;
            margin-bottom: 8px;
            padding: 3px 0;
            min-height: 30px;
            align-items: start;
        }
        
        .dish-item > div {
            padding: 0 5px;
            word-break: break-word;
        }
        
        .dish-quantity {
            font-weight: bold;
            text-align: center;
        }
        
        .dish-name {
            padding-left: 10px !important;
        }
        
        .dish-kitchen-type {
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            color: #d00;
        }
        
        /* ƒê∆∞·ªùng k·∫ª ngang */
        .divider {
            border-bottom: 1px dashed #000;
            margin: 10px 0;
        }
        
        /* N√∫t in */
        .print-buttons {
            margin-top: 20px;
            text-align: center;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .print-btn {
            background-color: #333;
            color: white;
            border: none;
            padding: 12px 16px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            font-size: 14px;
            flex: 1;
            min-width: 140px;
            max-width: 200px;
            margin-bottom: 5px;
            touch-action: manipulation;
        }
        
        .print-btn:hover {
            background-color: #555;
        }
        
        .print-btn-pho {
            background-color: #0066cc;
        }
        
        .print-btn-rice {
            background-color: #cc6600;
        }
        
        /* Ph·∫ßn th√¥ng tin */
        .order-info {
            text-align: center;
            margin-top: 10px;
            font-size: 12px;
        }
        
        /* Printer info */
        .printer-info {
            background-color: #f0f0f0;
            padding: 8px;
            margin-top: 10px;
            border-radius: 4px;
            font-size: 11px;
        }
        
        .printer-item {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            border-bottom: 1px dotted #ccc;
        }
        
        .printer-name {
            font-weight: bold;
            color: #0066cc;
        }
        
        /* Printer status */
        .printer-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .status-connected {
            background-color: #4CAF50;
            color: white;
        }
        
        .status-disconnected {
            background-color: #f44336;
            color: white;
        }
        
        /* Message box */
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
            max-width: 90%;
            width: 300px;
            text-align: center;
        }
        
        .message-box h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .message-box p {
            margin-bottom: 20px;
            line-height: 1.4;
        }
        
        .message-box-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .message-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            min-width: 80px;
        }
        
        .btn-primary {
            background-color: #2196F3;
            color: white;
        }
        
        .btn-secondary {
            background-color: #f5f5f5;
            color: #333;
        }
        
        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }
        
        /* ·∫®n khi kh√¥ng in */
        .no-print {
            display: block;
        }
        
        /* CSS cho n·ªôi dung in */
        @media print {
            body {
                padding: 0;
            }
            
            .order-container {
                border: none;
                padding: 10px;
                font-size: 12px;
            }
            
            .no-print {
                display: none !important;
            }
            
            .dish-header {
                grid-template-columns: 40px 1fr !important;
            }
            
            .dish-item {
                grid-template-columns: 40px 1fr !important;
            }
            
            .dish-header > div:nth-child(3),
            .dish-item > div:nth-child(3) {
                display: none !important;
            }
            
            @page {
                margin: 0.5cm;
                size: auto;
            }
        }
        
        /* T·ªëi ∆∞u cho mobile */
        @media (max-width: 480px) {
            .print-btn {
                padding: 14px 12px;
                font-size: 13px;
                min-width: 120px;
            }
            
            .order-container {
                padding: 10px;
            }
            
            .dish-header {
                grid-template-columns: 40px 1fr 60px;
            }
            
            .dish-item {
                grid-template-columns: 40px 1fr 60px;
            }
            
            .dish-kitchen-type {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="order-container">
        <div class="order-header">
            <div class="order-number" id="orderNumber">#0902-04-02</div>
            <div class="table-info" id="tableInfo">B√ÄN 1</div>
            <div class="service-name">ORDER B·∫æP</div>
        </div>
        
        <!-- Ti√™u ƒë·ªÅ c·ªôt -->
        <div class="dish-header">
            <div>SL</div>
            <div>T√äN M√ìN</div>
            <div>LO·∫†I B·∫æP</div>
        </div>
        
        <div class="dish-list" id="dishList">
            <!-- D·ªØ li·ªáu m√≥n ƒÉn s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
        </div>
        
        <div class="divider"></div>
        
        <!-- Th√¥ng tin m√°y in -->
        <div class="printer-info no-print">
            <div class="printer-item">
                <span>M√°y in B·∫øp Ph·ªü:</span>
                <span class="printer-name" id="phoPrinterName">Ch∆∞a c·∫•u h√¨nh</span>
                <span class="printer-status status-disconnected" id="phoPrinterStatus">CH∆ØA K·∫æT N·ªêI</span>
            </div>
            <div class="printer-item">
                <span>M√°y in B·∫øp C∆°m:</span>
                <span class="printer-name" id="ricePrinterName">Ch∆∞a c·∫•u h√¨nh</span>
                <span class="printer-status status-disconnected" id="ricePrinterStatus">CH∆ØA K·∫æT N·ªêI</span>
            </div>
        </div>
        
        <div class="order-footer">
            <div class="order-info" id="orderInfo">
                Order Time: 14:30
            </div>
        </div>
    </div>
    
    <div class="print-buttons no-print" id="printButtons">
        <!-- N√∫t in s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
    </div>

    <!-- Overlay -->
    <div class="overlay" id="overlay"></div>
    
    <!-- Message Box -->
    <div class="message-box" id="messageBox">
        <h3 id="messageTitle">TH√îNG B√ÅO</h3>
        <p id="messageText">N·ªôi dung th√¥ng b√°o</p>
        <div class="message-box-buttons">
            <button class="message-btn btn-primary" id="messageOkBtn">OK</button>
            <button class="message-btn btn-secondary" id="messageCancelBtn">H·ª¶Y</button>
        </div>
    </div>

    <script>
        // Bi·∫øn to√†n c·ª•c
        let allDishes = [];
        let hasPho = false;
        let hasRice = false;
        let orderNumber = '';
        let tableInfo = '';
        
        // C·∫•u h√¨nh m√°y in Xprinter K200L
        let printerConfig = {
            pho: {
                ip: '',
                port: 9100,
                name: '',
                connected: false,
                useDirectPrint: false
            },
            rice: {
                ip: '',
                port: 9100,
                name: '',
                connected: false,
                useDirectPrint: false
            }
        };
        
        // ESC/POS commands for Xprinter
        const ESCPOS_COMMANDS = {
            INIT: '\x1B\x40',           // Initialize printer
            BOLD_ON: '\x1B\x45\x01',   // Bold ON
            BOLD_OFF: '\x1B\x45\x00',  // Bold OFF
            ALIGN_LEFT: '\x1B\x61\x00', // Align left
            ALIGN_CENTER: '\x1B\x61\x01', // Align center
            ALIGN_RIGHT: '\x1B\x61\x02', // Align right
            LINE_FEED: '\x0A',          // Line feed
            CUT_PAPER: '\x1D\x56\x00'   // Cut paper
        };

        // H√†m l·∫•y tham s·ªë t·ª´ URL
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // H√†m decode HTML entities
        function decodeHtmlEntities(text) {
            const textarea = document.createElement('textarea');
            textarea.innerHTML = text;
            return textarea.value;
        }

        // H√†m parse d·ªØ li·ªáu m√≥n ƒÉn t·ª´ URL
        function parseDishesFromUrl() {
            const dishesParam = getUrlParameter('data');
            if (!dishesParam) return null;
            
            const decodedParam = decodeURIComponent(dishesParam);
            const cleanParam = decodeHtmlEntities(decodedParam);
            
            const rows = cleanParam.split('_b_');
            const dishes = [];
            
            rows.forEach(row => {
                if (row.trim() === '') return;
                
                const columns = row.split('_a_');
                while (columns.length < 3) {
                    columns.push('');
                }
                
                const kitchenType = columns[2] || 'B·∫æP CH√çNH';
                let kitchenClass = 'other-item';
                
                if (kitchenType.toLowerCase().includes('ph·ªü') || 
                    kitchenType.toLowerCase().includes('pho')) {
                    kitchenClass = 'pho-item';
                } else if (kitchenType.toLowerCase().includes('c∆°m') || 
                          kitchenType.toLowerCase().includes('com') || 
                          kitchenType.toLowerCase().includes('rice')) {
                    kitchenClass = 'rice-item';
                }
                
                dishes.push({
                    quantity: columns[0] || '1',
                    name: columns[1] || '',
                    kitchenType: kitchenType,
                    kitchenClass: kitchenClass
                });
            });
            
            return dishes;
        }

        // H√†m ki·ªÉm tra lo·∫°i b·∫øp
        function checkKitchenTypes(dishes) {
            const hasPho = dishes.some(dish => dish.kitchenClass === 'pho-item');
            const hasRice = dishes.some(dish => dish.kitchenClass === 'rice-item');
            return { hasPho, hasRice };
        }

        // H√†m t·∫°o m√£ HTML cho m√≥n ƒÉn
        function createDishItem(dish) {
            return `
                <div class="dish-item">
                    <div class="dish-quantity">${dish.quantity || 1}</div>
                    <div class="dish-name">${dish.name || ''}</div>
                    <div class="dish-kitchen-type">${dish.kitchenType || 'B·∫æP CH√çNH'}</div>
                </div>
            `;
        }

        // H√†m hi·ªÉn th·ªã t·∫•t c·∫£ m√≥n
        function showAllDishes() {
            const dishListElement = document.getElementById('dishList');
            let dishesHtml = '';
            allDishes.forEach(dish => {
                dishesHtml += createDishItem(dish);
            });
            dishListElement.innerHTML = dishesHtml;
        }

        // H√†m t·∫°o n√∫t in
        function createPrintButtons() {
            const printButtonsDiv = document.getElementById('printButtons');
            let buttonsHtml = '';
            
            if (hasPho) {
                buttonsHtml += `
                    <button class="print-btn print-btn-pho" id="printPhoBtn">
                        IN B·∫æP PH·ªû
                    </button>
                `;
            }
            
            if (hasRice) {
                buttonsHtml += `
                    <button class="print-btn print-btn-rice" id="printRiceBtn">
                        IN B·∫æP C∆†M
                    </button>
                `;
            }
            
            printButtonsDiv.innerHTML = buttonsHtml;
            
            // Th√™m event listener - s·ª≠ d·ª•ng click cho mobile
            if (hasPho) {
                const btn = document.getElementById('printPhoBtn');
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    printToPrinter('pho');
                });
            }
            
            if (hasRice) {
                const btn = document.getElementById('printRiceBtn');
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    printToPrinter('rice');
                });
            }
        }

        // H√†m load c·∫•u h√¨nh m√°y in t·ª´ URL
        function loadPrinterConfigFromUrl() {
            // IP m√°y in B·∫øp Ph·ªü
            const phoIP = getUrlParameter('printer_pho_ip');
            const phoName = getUrlParameter('printer_pho_name');
            const phoDirect = getUrlParameter('printer_pho_direct') === 'true';
            
            // IP m√°y in B·∫øp C∆°m
            const riceIP = getUrlParameter('printer_rice_ip');
            const riceName = getUrlParameter('printer_rice_name');
            const riceDirect = getUrlParameter('printer_rice_direct') === 'true';
            
            // C·ªïng m·∫∑c ƒë·ªãnh 9100 cho m√°y in nhi·ªát qua TCP
            const phoPort = getUrlParameter('printer_pho_port') || 9100;
            const ricePort = getUrlParameter('printer_rice_port') || 9100;
            
            if (phoIP) {
                printerConfig.pho.ip = phoIP;
                printerConfig.pho.port = parseInt(phoPort);
                printerConfig.pho.name = phoName || `Xprinter Ph·ªü (${phoIP})`;
                printerConfig.pho.useDirectPrint = phoDirect;
                document.getElementById('phoPrinterName').textContent = printerConfig.pho.name;
            }
            
            if (riceIP) {
                printerConfig.rice.ip = riceIP;
                printerConfig.rice.port = parseInt(ricePort);
                printerConfig.rice.name = riceName || `Xprinter C∆°m (${riceIP})`;
                printerConfig.rice.useDirectPrint = riceDirect;
                document.getElementById('ricePrinterName').textContent = printerConfig.rice.name;
            }
            
            // C·∫≠p nh·∫≠t tr·∫°ng th√°i
            updatePrinterStatus();
        }

        // H√†m c·∫≠p nh·∫≠t tr·∫°ng th√°i m√°y in
        function updatePrinterStatus() {
            const phoStatus = document.getElementById('phoPrinterStatus');
            const riceStatus = document.getElementById('ricePrinterStatus');
            
            if (printerConfig.pho.ip) {
                phoStatus.textContent = 'S·∫¥N S√ÄNG';
                phoStatus.className = 'printer-status status-connected';
                printerConfig.pho.connected = true;
            }
            
            if (printerConfig.rice.ip) {
                riceStatus.textContent = 'S·∫¥N S√ÄNG';
                riceStatus.className = 'printer-status status-connected';
                printerConfig.rice.connected = true;
            }
        }

        // H√†m t·∫°o ESC/POS commands cho h√≥a ƒë∆°n
        function createEscPosContent(kitchenType) {
            const currentTime = getCurrentTime();
            let filteredDishes = [];
            
            if (kitchenType === 'pho') {
                filteredDishes = allDishes.filter(dish => dish.kitchenClass === 'pho-item');
            } else if (kitchenType === 'rice') {
                filteredDishes = allDishes.filter(dish => dish.kitchenClass === 'rice-item');
            }
            
            // T·∫°o ESC/POS commands
            let commands = '';
            
            // Initialize printer
            commands += ESCPOS_COMMANDS.INIT;
            
            // Center alignment for header
            commands += ESCPOS_COMMANDS.ALIGN_CENTER;
            commands += ESCPOS_COMMANDS.BOLD_ON;
            commands += 'ORDER B·∫æP ' + (kitchenType === 'pho' ? 'PH·ªû' : 'C∆†M') + '\n';
            commands += ESCPOS_COMMANDS.BOLD_OFF;
            
            // Order info
            commands += ESCPOS_COMMANDS.ALIGN_LEFT;
            commands += orderNumber + '\n';
            commands += tableInfo + '\n';
            commands += 'Th·ªùi gian: ' + currentTime + '\n\n';
            
            // Line separator
            commands += '--------------------------------\n';
            
            // Dishes header
            commands += ESCPOS_COMMANDS.BOLD_ON;
            commands += 'SL  T√äN M√ìN\n';
            commands += ESCPOS_COMMANDS.BOLD_OFF;
            commands += '--------------------------------\n';
            
            // Dishes list
            filteredDishes.forEach(dish => {
                const quantity = dish.quantity.toString().padEnd(3, ' ');
                const name = dish.name;
                commands += quantity + ' ' + name + '\n';
            });
            
            // Footer
            commands += '\n--------------------------------\n';
            commands += ESCPOS_COMMANDS.ALIGN_CENTER;
            commands += 'C·∫¢M ∆†N QU√ù KH√ÅCH!\n';
            commands += 'B·∫æP ' + (kitchenType === 'pho' ? 'PH·ªû' : 'C∆†M') + '\n\n\n';
            
            // Cut paper
            commands += ESCPOS_COMMANDS.CUT_PAPER;
            
            return commands;
        }

        // H√†m in qua ph∆∞∆°ng ph√°p m·ªõi (Web Bluetooth ho·∫∑c TCP qua app)
        async function printViaMobileMethods(kitchenType) {
            const printer = printerConfig[kitchenType];
            
            // Ph∆∞∆°ng √°n 1: In tr·ª±c ti·∫øp qua TCP (ch·ªâ ho·∫°t ƒë·ªông v·ªõi app ho·∫∑c proxy)
            if (printer.useDirectPrint) {
                return await printViaDirectTCP(kitchenType);
            }
            
            // Ph∆∞∆°ng √°n 2: T·∫£i file v√† h∆∞·ªõng d·∫´n in
            return await printViaFileDownload(kitchenType);
        }

        // H√†m t·∫°o v√† t·∫£i file in
        async function printViaFileDownload(kitchenType) {
            const escPosContent = createEscPosContent(kitchenType);
            const printer = printerConfig[kitchenType];
            
            // T·∫°o blob t·ª´ ESC/POS commands
            const blob = new Blob([escPosContent], { 
                type: 'application/octet-stream' 
            });
            
            // T·∫°o URL cho blob
            const url = URL.createObjectURL(blob);
            
            // T·∫°o th·∫ª a ƒë·ªÉ t·∫£i xu·ªëng
            const a = document.createElement('a');
            a.href = url;
            a.download = `order_${kitchenType}_${Date.now()}.prn`;
            document.body.appendChild(a);
            a.click();
            
            // D·ªçn d·∫πp
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
            
            // Hi·ªÉn th·ªã h∆∞·ªõng d·∫´n
            const instructions = `
                <strong>ƒê√£ t·∫°o file in th√†nh c√¥ng!</strong><br><br>
                
                <strong>C√°c b∆∞·ªõc in:</strong><br>
                1. M·ªü app in nhi·ªát tr√™n ƒëi·ªán tho·∫°i<br>
                2. Ch·ªçn file v·ª´a t·∫£i: <code>${a.download}</code><br>
                3. Ch·ªçn m√°y in: <strong>${printer.name}</strong><br>
                4. Nh·∫•n n√∫t in<br><br>
                
                <strong>·ª®ng d·ª•ng g·ª£i √Ω:</strong><br>
                ‚Ä¢ PrintBot (Android/iOS)<br>
                ‚Ä¢ IP Printer (Android)<br>
                ‚Ä¢ PrintShare (Android/iOS)<br><br>
                
                <em>L∆∞u √Ω: C·∫ßn c√†i app v√† c·∫•u h√¨nh m√°y in tr∆∞·ªõc</em>
            `;
            
            const confirmed = await showConfirm('H∆∞·ªõng d·∫´n in', instructions);
            
            if (confirmed) {
                logPrintActivity(kitchenType, true);
                return true;
            }
            
            return false;
        }

        // H√†m in qua direct TCP (ch·ªâ ho·∫°t ƒë·ªông v·ªõi WebView ƒë·∫∑c bi·ªát)
        async function printViaDirectTCP(kitchenType) {
            const printer = printerConfig[kitchenType];
            const escPosContent = createEscPosContent(kitchenType);
            
            try {
                // Th·ª≠ s·ª≠ d·ª•ng WebSocket n·∫øu c√≥ server proxy
                const ws = new WebSocket(`ws://${printer.ip}:${printer.port}`);
                
                return new Promise((resolve, reject) => {
                    ws.onopen = () => {
                        ws.send(escPosContent);
                        setTimeout(() => {
                            ws.close();
                            resolve(true);
                        }, 1000);
                    };
                    
                    ws.onerror = () => {
                        reject(new Error('Kh√¥ng th·ªÉ k·∫øt n·ªëi WebSocket'));
                    };
                    
                    setTimeout(() => reject(new Error('Timeout')), 3000);
                });
            } catch (error) {
                throw error;
            }
        }

        // H√†m in ch√≠nh
        async function printToPrinter(kitchenType) {
            // C·∫≠p nh·∫≠t th·ªùi gian
            updateOrderTime();
            
            const printer = printerConfig[kitchenType];
            
            if (!printer.ip) {
                await showMessage('Ch∆∞a c·∫•u h√¨nh', 
                    `Vui l√≤ng c·∫•u h√¨nh IP m√°y in B·∫øp ${kitchenType === 'pho' ? 'Ph·ªü' : 'C∆°m'} qua URL:<br><br>
                    <code>?printer_${kitchenType}_ip=192.168.1.100</code><br><br>
                    V√≠ d·ª•: printer_pho_ip=192.168.1.101<br>
                    printer_rice_ip=192.168.1.102`);
                return;
            }
            
            // Hi·ªÉn th·ªã t√πy ch·ªçn in
            const printMethod = await showPrintMethodDialog(kitchenType);
            
            if (!printMethod) return;
            
            if (printMethod === 'download') {
                // In qua file download
                await printViaFileDownload(kitchenType);
            } else if (printMethod === 'window') {
                // In qua c·ª≠a s·ªï in th√¥ng th∆∞·ªùng
                printToWindow(kitchenType);
                logPrintActivity(kitchenType, true);
            } else if (printMethod === 'direct' && printer.useDirectPrint) {
                // Th·ª≠ in tr·ª±c ti·∫øp
                try {
                    await printViaDirectTCP(kitchenType);
                    await showMessage('Th√†nh c√¥ng', `ƒê√£ g·ª≠i l·ªánh in ƒë·∫øn ${printer.name}`);
                    logPrintActivity(kitchenType, true);
                } catch (error) {
                    await showMessage('L·ªói', `Kh√¥ng th·ªÉ in tr·ª±c ti·∫øp: ${error.message}`);
                }
            }
        }

        // H√†m hi·ªÉn th·ªã dialog ch·ªçn ph∆∞∆°ng ph√°p in
        async function showPrintMethodDialog(kitchenType) {
            const printer = printerConfig[kitchenType];
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            
            let message = `<strong>Ch·ªçn ph∆∞∆°ng th·ª©c in cho ${printer.name}</strong><br><br>`;
            
            if (isMobile) {
                message += `
                <strong>üì± Cho ƒëi·ªán tho·∫°i:</strong><br>
                1. <strong>T·∫£i file in</strong> - D√πng app in nhi·ªát<br>
                2. <strong>In th√¥ng th∆∞·ªùng</strong> - Ch·ªçn m√°y in AirPrint/Google Cloud Print<br><br>
                
                <strong>üíª Cho m√°y t√≠nh:</strong><br>
                3. <strong>In th√¥ng th∆∞·ªùng</strong> - Ch·ªçn m√°y in trong m·∫°ng<br>
                `;
                
                if (printer.useDirectPrint) {
                    message += `4. <strong>In tr·ª±c ti·∫øp</strong> - Th·ª≠ k·∫øt n·ªëi TCP tr·ª±c ti·∫øp<br><br>`;
                }
            } else {
                message += `
                <strong>üíª Cho m√°y t√≠nh:</strong><br>
                1. <strong>In th√¥ng th∆∞·ªùng</strong> - Ch·ªçn m√°y in trong m·∫°ng (khuy·∫øn ngh·ªã)<br>
                2. <strong>T·∫£i file in</strong> - D√πng ph·∫ßn m·ªÅm in ESC/POS<br><br>
                `;
                
                if (printer.useDirectPrint) {
                    message += `3. <strong>In tr·ª±c ti·∫øp</strong> - Th·ª≠ k·∫øt n·ªëi TCP tr·ª±c ti·∫øp<br><br>`;
                }
            }
            
            // T·∫°o custom dialog
            return new Promise((resolve) => {
                const dialogHtml = `
                    <div style="text-align: left; margin: 15px 0;">
                        ${message}
                        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
                            ${isMobile ? `
                            <button id="btnDownload" style="padding: 12px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                üì• T·∫£i file in (cho app in nhi·ªát)
                            </button>
                            <button id="btnWindow" style="padding: 12px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                üñ®Ô∏è In th√¥ng th∆∞·ªùng
                            </button>
                            ` : `
                            <button id="btnWindow" style="padding: 12px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                üñ®Ô∏è In th√¥ng th∆∞·ªùng (khuy·∫øn ngh·ªã)
                            </button>
                            <button id="btnDownload" style="padding: 12px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                üì• T·∫£i file in
                            </button>
                            `}
                            ${printer.useDirectPrint ? `
                            <button id="btnDirect" style="padding: 12px; background: #FF9800; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                ‚ö° In tr·ª±c ti·∫øp (th·ª≠ nghi·ªám)
                            </button>
                            ` : ''}
                            <button id="btnCancel" style="padding: 12px; background: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
                                H·ªßy
                            </button>
                        </div>
                    </div>
                `;
                
                document.getElementById('messageTitle').textContent = 'CH·ªåN PH∆Ø∆†NG TH·ª®C IN';
                document.getElementById('messageText').innerHTML = dialogHtml;
                document.getElementById('messageCancelBtn').style.display = 'none';
                document.getElementById('messageOkBtn').style.display = 'none';
                
                document.getElementById('overlay').style.display = 'block';
                document.getElementById('messageBox').style.display = 'block';
                
                // Th√™m event listeners
                setTimeout(() => {
                    const btnDownload = document.getElementById('btnDownload');
                    const btnWindow = document.getElementById('btnWindow');
                    const btnDirect = document.getElementById('btnDirect');
                    const btnCancel = document.getElementById('btnCancel');
                    
                    if (btnDownload) {
                        btnDownload.onclick = () => {
                            hideMessageBox();
                            resolve('download');
                        };
                    }
                    
                    if (btnWindow) {
                        btnWindow.onclick = () => {
                            hideMessageBox();
                            resolve('window');
                        };
                    }
                    
                    if (btnDirect) {
                        btnDirect.onclick = () => {
                            hideMessageBox();
                            resolve('direct');
                        };
                    }
                    
                    btnCancel.onclick = () => {
                        hideMessageBox();
                        resolve(null);
                    };
                }, 100);
            });
        }

        // H√†m in ra c·ª≠a s·ªï (fallback)
        function printToWindow(kitchenType) {
            const printContent = createPrintContent(kitchenType);
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.print();
                setTimeout(() => {
                    if (!printWindow.closed) {
                        printWindow.close();
                    }
                }, 500);
            }, 500);
        }

        // H√†m t·∫°o HTML cho in th√¥ng th∆∞·ªùng
        function createPrintContent(kitchenType) {
            const currentTime = getCurrentTime();
            let filteredDishes = [];
            
            if (kitchenType === 'pho') {
                filteredDishes = allDishes.filter(dish => dish.kitchenClass === 'pho-item');
            } else if (kitchenType === 'rice') {
                filteredDishes = allDishes.filter(dish => dish.kitchenClass === 'rice-item');
            }
            
            let dishesHtml = '';
            filteredDishes.forEach(dish => {
                dishesHtml += `
                    <div class="dish-item">
                        <div class="dish-quantity">${dish.quantity}</div>
                        <div class="dish-name">${dish.name}</div>
                    </div>
                `;
            });
            
            return `
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <style>
                    * { margin: 0; padding: 0; box-sizing: border-box; }
                    body { font-family: 'Arial', monospace; padding: 10px; font-size: 14px; line-height: 1.2; }
                    .header { text-align: center; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px dashed #000; }
                    .order-number { font-weight: bold; font-size: 16px; }
                    .table-info { font-weight: bold; font-size: 18px; margin: 5px 0; }
                    .service-name { font-weight: bold; margin-bottom: 15px; }
                    .dish-header { display: grid; grid-template-columns: 40px 1fr; margin-bottom: 5px; font-weight: bold; border-bottom: 1px solid #000; padding-bottom: 3px; }
                    .dish-item { display: grid; grid-template-columns: 40px 1fr; margin-bottom: 8px; padding: 3px 0; }
                    .dish-quantity { font-weight: bold; text-align: center; }
                    .footer { text-align: center; margin-top: 15px; font-size: 12px; border-top: 1px dashed #000; padding-top: 8px; }
                    @page { margin: 0.5cm; size: auto; }
                    @media print {
                        body { padding: 0; }
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <div class="order-number">${orderNumber}</div>
                    <div class="table-info">${tableInfo}</div>
                    <div class="service-name">ORDER B·∫æP ${kitchenType === 'pho' ? 'PH·ªû' : 'C∆†M'}</div>
                </div>
                
                <div class="dish-header">
                    <div>SL</div>
                    <div>T√äN M√ìN</div>
                </div>
                
                ${dishesHtml}
                
                <div class="footer">
                    <div>Order Time: ${currentTime}</div>
                    <div>In l√∫c: ${getCurrentTime()}</div>
                </div>
                
                <script>
                    window.onload = function() {
                        setTimeout(function() {
                            window.print();
                            setTimeout(function() { 
                                if (window.opener && !window.opener.closed) {
                                    window.close();
                                }
                            }, 500);
                        }, 300);
                    };
                <\/script>
            </body>
            </html>
            `;
        }

        // H√†m hi·ªÉn th·ªã message box
        function showMessage(title, text) {
            document.getElementById('messageTitle').textContent = title;
            document.getElementById('messageText').innerHTML = text;
            document.getElementById('messageCancelBtn').style.display = 'none';
            document.getElementById('messageOkBtn').style.display = 'inline-block';
            document.getElementById('messageOkBtn').textContent = 'OK';
            
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('messageBox').style.display = 'block';
            
            return new Promise((resolve) => {
                const handler = () => {
                    hideMessageBox();
                    resolve(true);
                    document.getElementById('messageOkBtn').removeEventListener('click', handler);
                };
                document.getElementById('messageOkBtn').addEventListener('click', handler);
            });
        }

        // H√†m hi·ªÉn th·ªã confirm box
        function showConfirm(title, text) {
            document.getElementById('messageTitle').textContent = title;
            document.getElementById('messageText').innerHTML = text;
            document.getElementById('messageCancelBtn').style.display = 'inline-block';
            document.getElementById('messageOkBtn').style.display = 'inline-block';
            document.getElementById('messageOkBtn').textContent = 'ƒê·ªíNG √ù';
            
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('messageBox').style.display = 'block';
            
            return new Promise((resolve) => {
                const okHandler = () => {
                    hideMessageBox();
                    resolve(true);
                    document.getElementById('messageOkBtn').removeEventListener('click', okHandler);
                    document.getElementById('messageCancelBtn').removeEventListener('click', cancelHandler);
                };
                
                const cancelHandler = () => {
                    hideMessageBox();
                    resolve(false);
                    document.getElementById('messageOkBtn').removeEventListener('click', okHandler);
                    document.getElementById('messageCancelBtn').removeEventListener('click', cancelHandler);
                };
                
                document.getElementById('messageOkBtn').addEventListener('click', okHandler);
                document.getElementById('messageCancelBtn').addEventListener('click', cancelHandler);
            });
        }

        // H√†m ·∫©n message box
        function hideMessageBox() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('messageBox').style.display = 'none';
            document.getElementById('messageCancelBtn').style.display = 'inline-block';
            document.getElementById('messageOkBtn').style.display = 'inline-block';
        }

        // H√†m log ho·∫°t ƒë·ªông in
        function logPrintActivity(kitchenType, success) {
            const log = {
                timestamp: new Date().toISOString(),
                kitchen: kitchenType,
                printer: printerConfig[kitchenType].name,
                order: orderNumber,
                table: tableInfo,
                success: success
            };
            
            // L∆∞u v√†o localStorage
            try {
                const logs = JSON.parse(localStorage.getItem('printLogs') || '[]');
                logs.unshift(log);
                if (logs.length > 50) logs.pop();
                localStorage.setItem('printLogs', JSON.stringify(logs));
            } catch (e) {
                console.log('Kh√¥ng th·ªÉ l∆∞u log:', e);
            }
            
            console.log('Print log:', log);
        }

        // H√†m c·∫≠p nh·∫≠t th·ªùi gian
        function updateOrderTime() {
            const orderInfoElement = document.getElementById('orderInfo');
            const currentTime = getCurrentTime();
            orderInfoElement.textContent = `Order Time: ${currentTime}`;
        }

        // H√†m l·∫•y th·ªùi gian hi·ªán t·∫°i
        function getCurrentTime() {
            const now = new Date();
            return now.getHours().toString().padStart(2, '0') + ':' + 
                   now.getMinutes().toString().padStart(2, '0');
        }

        // H√†m c·∫≠p nh·∫≠t th√¥ng tin t·ª´ URL
        function updateOrderFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // C·∫≠p nh·∫≠t s·ªë b√†n
            const table = getUrlParameter('table');
            if (table) {
                tableInfo = `B√ÄN ${table}`;
                document.getElementById('tableInfo').textContent = tableInfo;
            }
            
            // C·∫≠p nh·∫≠t s·ªë order
            const orderNum = getUrlParameter('order');
            if (orderNum) {
                orderNumber = `#${orderNum}`;
                document.getElementById('orderNumber').textContent = orderNumber;
            }
            
            // C·∫≠p nh·∫≠t th·ªùi gian
            updateOrderTime();
            
            // C·∫≠p nh·∫≠t danh s√°ch m√≥n ƒÉn
            const dishes = parseDishesFromUrl();
            
            if (dishes && dishes.length > 0) {
                allDishes = dishes;
                showAllDishes();
                
                const kitchenTypes = checkKitchenTypes(dishes);
                hasPho = kitchenTypes.hasPho;
                hasRice = kitchenTypes.hasRice;
                
                createPrintButtons();
            } else {
                // D·ªØ li·ªáu m·∫´u
                allDishes = [
                    { quantity: '2', name: 'Ph·ªü b√≤ t√°i ch√≠n', kitchenType: 'B·∫æP PH·ªû', kitchenClass: 'pho-item' },
                    { quantity: '1', name: 'Ph·ªü g√†', kitchenType: 'B·∫æP PH·ªû', kitchenClass: 'pho-item' },
                    { quantity: '1', name: 'C∆°m rang b√≤', kitchenType: 'B·∫æP C∆†M', kitchenClass: 'rice-item' },
                    { quantity: '2', name: 'C∆°m rang th·∫≠p c·∫©m', kitchenType: 'B·∫æP C∆†M', kitchenClass: 'rice-item' },
                ];
                
                showAllDishes();
                hasPho = true;
                hasRice = true;
                orderNumber = '#0902-04-02';
                tableInfo = 'B√ÄN 1';
                createPrintButtons();
            }
            
            // Load c·∫•u h√¨nh m√°y in t·ª´ URL
            loadPrinterConfigFromUrl();
        }

        // Khi trang t·∫£i xong
        document.addEventListener('DOMContentLoaded', function() {
            updateOrderFromUrl();
            
            // Close message box khi click overlay
            document.getElementById('overlay').addEventListener('click', hideMessageBox);
            
            // NgƒÉn zoom tr√™n mobile
            document.addEventListener('touchmove', function(e) {
                if (e.scale !== 1) {
                    e.preventDefault();
                }
            }, { passive: false });
        });
    </script>
</body>
</html>
