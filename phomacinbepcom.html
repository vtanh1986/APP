<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHON IN BEP</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: Arial, monospace;
            padding: 10px;
            max-width: 500px;
            margin: 0 auto;
            background-color: #f5f5f5;
        }
        
        .order-container {
            background: white;
            border: 1px solid #000;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .order-header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #000;
        }
        
        .order-number { font-weight: bold; font-size: 16px; margin-bottom: 5px; }
        .table-info { font-weight: bold; font-size: 18px; margin-bottom: 5px; color: #d00; }
        .service-name { margin-bottom: 15px; font-weight: bold; }
        
        .dish-header {
            display: grid;
            grid-template-columns: 50px 1fr 70px;
            font-weight: bold;
            padding-bottom: 3px;
            border-bottom: 1px solid #000;
        }
        
        .dish-item {
            display: grid;
            grid-template-columns: 50px 1fr 70px;
            margin: 8px 0;
            padding: 3px 0;
        }
        
        .dish-quantity { font-weight: bold; text-align: center; }
        .dish-name { padding-left: 10px; }
        .dish-kitchen-type { font-size: 12px; font-weight: bold; text-align: center; color: #d00; }
        
        .divider { border-bottom: 1px dashed #000; margin: 10px 0; }
        
        .print-buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .print-btn {
            background: #333;
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            min-width: 140px;
        }
        
        .print-btn-pho { background-color: #0066cc; }
        .print-btn-rice { background-color: #cc6600; }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
        }
        
        .modal-content {
            background: white;
            margin: 20% auto;
            padding: 25px;
            border-radius: 10px;
            width: 85%;
            max-width: 400px;
        }
        
        .modal-header { font-size: 18px; font-weight: bold; margin-bottom: 15px; text-align: center; }
        .modal-body { margin-bottom: 20px; text-align: center; line-height: 1.5; }
        
        .modal-buttons { display: flex; gap: 10px; justify-content: center; }
        
        .modal-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .modal-btn-primary { background: #4CAF50; color: white; }
        .modal-btn-cancel { background: #999; color: white; }
        
        .status-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #4caf50;
            color: white;
            padding: 15px 25px;
            border-radius: 5px;
            z-index: 9999;
            display: none;
        }
        
        .status-message.error { background: #f44336; }
        
        .print-content { display: none; }
        
        @media print {
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { 
                margin: 0 !important; 
                padding: 5mm 3mm !important; 
                background: white;
                font-size: 18px !important;
            }
            .order-container, .print-buttons, .modal { display: none !important; }
            .print-content { 
                display: block !important;
            }
            
            .print-header {
                text-align: center;
                margin-bottom: 10px;
                padding-bottom: 10px;
                border-bottom: 2px solid #000;
            }
            
            .print-order-num { font-weight: bold; font-size: 20px; margin: 5px 0; }
            .print-table-num { font-weight: bold; font-size: 28px; margin: 5px 0; }
            .print-kitchen-name { font-weight: bold; font-size: 24px; margin: 8px 0; }
            
            .print-dish-header {
                display: flex;
                font-weight: bold;
                border-bottom: 2px solid #000;
                padding: 8px 0;
                margin: 10px 0;
                font-size: 18px;
            }
            
            .print-dish-header > div:first-child { width: 60px; text-align: center; }
            .print-dish-header > div:last-child { flex: 1; padding-left: 10px; }
            
            .print-dish-item {
                display: flex;
                margin: 8px 0;
                padding: 5px 0;
                border-bottom: 1px dotted #999;
                font-size: 18px;
            }
            
            .print-dish-item > div:first-child { width: 60px; font-weight: bold; text-align: center; }
            .print-dish-item > div:last-child { flex: 1; padding-left: 10px; line-height: 1.4; }
            
            .print-footer {
                text-align: center;
                margin-top: 15px;
                padding-top: 10px;
                border-top: 2px solid #000;
                font-size: 16px;
            }
            
            @page { 
                margin: 0; 
                size: 80mm auto;
            }
        }
    </style>
</head>
<body>
    <div id="statusMessage" class="status-message"></div>

    <div id="printModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">‚ö†Ô∏è Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c ESC/POS</div>
            <div class="modal-body">
                Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi Open ESC/POS.<br><br>
                B·∫°n mu·ªën in b·∫±ng m√°y in th√¥ng th∆∞·ªùng kh√¥ng?
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-primary" onclick="confirmFallback()">
                    ‚úÖ In m√°y kh√°c
                </button>
                <button class="modal-btn modal-btn-cancel" onclick="closeModal()">
                    ‚ùå H·ªßy
                </button>
            </div>
        </div>
    </div>

    <div class="order-container">
        <div class="order-header">
            <div class="order-number" id="orderNumber">#0902-04-02</div>
            <div class="table-info" id="tableInfo">B√ÄN 1</div>
            <div class="service-name">ORDER B·∫æP</div>
        </div>
        
        <div class="dish-header">
            <div>SL</div>
            <div>T√äN M√ìN</div>
            <div>LO·∫†I B·∫æP</div>
        </div>
        
        <div class="dish-list" id="dishList"></div>
        
        <div class="divider"></div>
        
        <div class="order-info" style="text-align: center; margin-top: 10px; font-size: 12px;" id="orderInfo">
            Order Time: 14:30
        </div>
    </div>
    
    <div class="print-buttons" id="printButtons"></div>
    <div id="printContent" class="print-content"></div>

    <script>
        // ========================================
        // C·∫§U H√åNH M√ÅY IN - THAY ƒê·ªîI ·ªû ƒê√ÇY
        // ========================================
        const PRINTER_CONFIG = {
            pho: {
                ip: '192.168.100.234',    // IP m√°y in b·∫øp ph·ªü
                port: '9100'             // Port m√°y in b·∫øp ph·ªü (th∆∞·ªùng l√† 9100)
            },
            rice: {
                ip: '192.168.100.234',    // IP m√°y in b·∫øp c∆°m
                port: '9100'             // Port m√°y in b·∫øp c∆°m (th∆∞·ªùng l√† 9100)
            }
        };
        // ========================================
        
        let allDishes = [];
        let hasPho = false;
        let hasRice = false;
        let orderNumber = '';
        let tableInfo = '';
        let currentKitchenType = '';
        let intentTimeout = null;
        
        function showStatus(msg, type = 'success') {
            const div = document.getElementById('statusMessage');
            div.textContent = msg;
            div.className = `status-message ${type}`;
            div.style.display = 'block';
            setTimeout(() => div.style.display = 'none', 3000);
        }
        
        function showModal() {
            document.getElementById('printModal').style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('printModal').style.display = 'none';
        }
        
        function confirmFallback() {
            closeModal();
            showStatus('Chuy·ªÉn sang m√°y in th√¥ng th∆∞·ªùng...', 'success');
            setTimeout(() => fallbackPrint(currentKitchenType), 500);
        }
        
        function getUrlParameter(name) {
            return new URLSearchParams(window.location.search).get(name);
        }
        
        function decodeHtmlEntities(text) {
            const textarea = document.createElement('textarea');
            textarea.innerHTML = text;
            return textarea.value;
        }
        
        function parseDishesFromUrl() {
            const param = getUrlParameter('data');
            if (!param) return null;
            
            const decoded = decodeHtmlEntities(decodeURIComponent(param));
            const rows = decoded.split('_b_');
            const dishes = [];
            
            rows.forEach(row => {
                if (!row.trim()) return;
                const cols = row.split('_a_');
                while (cols.length < 3) cols.push('');
                
                const kitchenType = cols[2] || 'B·∫æP CH√çNH';
                let kitchenClass = 'other-item';
                
                if (kitchenType.toLowerCase().includes('ph·ªü') || kitchenType.toLowerCase().includes('pho')) {
                    kitchenClass = 'pho-item';
                } else if (kitchenType.toLowerCase().includes('c∆°m') || kitchenType.toLowerCase().includes('com')) {
                    kitchenClass = 'rice-item';
                }
                
                dishes.push({
                    quantity: cols[0] || '1',
                    name: cols[1] || '',
                    kitchenType: kitchenType,
                    kitchenClass: kitchenClass
                });
            });
            
            return dishes;
        }
        
        function showAllDishes() {
            const list = document.getElementById('dishList');
            list.innerHTML = allDishes.map(d => `
                <div class="dish-item">
                    <div class="dish-quantity">${d.quantity}</div>
                    <div class="dish-name">${d.name}</div>
                    <div class="dish-kitchen-type">${d.kitchenType}</div>
                </div>
            `).join('');
        }
        
        function createPrintButtons() {
            let html = '';
            if (hasPho) html += '<button class="print-btn print-btn-pho" onclick="printKitchen(\'pho\')">üñ®Ô∏è IN B·∫æP PH·ªû</button>';
            if (hasRice) html += '<button class="print-btn print-btn-rice" onclick="printKitchen(\'rice\')">üñ®Ô∏è IN B·∫æP C∆†M</button>';
            document.getElementById('printButtons').innerHTML = html;
        }
        
        function createPrintHTML(type) {
            const time = getCurrentTime();
            let dishes = [];
            let name = '';
            
            if (type === 'pho') {
                dishes = allDishes.filter(d => d.kitchenClass === 'pho-item');
                name = 'B·∫æP PH·ªû';
            } else if (type === 'rice') {
                dishes = allDishes.filter(d => d.kitchenClass === 'rice-item');
                name = 'B·∫æP C∆†M';
            }
            
            const dishesHtml = dishes.map(d => `
                <div class="dish">
                    <div>${d.quantity}</div>
                    <div>${d.name}</div>
                </div>
            `).join('');
            
            return `<!DOCTYPE html>
<html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><style>
*{margin:0;padding:0;box-sizing:border-box}
@page{margin:0;size:80mm auto}
html,body{width:100%;margin:0;padding:0}
body{padding:5mm 3mm;font-family:monospace;font-size:18px;line-height:1.3}
.header{text-align:center;margin-bottom:10px;padding-bottom:10px;border-bottom:2px solid #000}
.order-num{font-weight:bold;font-size:20px;margin:5px 0}
.table-num{font-weight:bold;font-size:28px;margin:5px 0}
.kitchen-name{font-weight:bold;font-size:24px;margin:8px 0}
.col-header{display:flex;font-weight:bold;border-bottom:2px solid #000;padding:8px 0;margin:10px 0;font-size:18px}
.col-header>div:first-child{width:50px;text-align:center}
.col-header>div:last-child{flex:1;padding-left:10px}
.dish{display:flex;margin:8px 0;padding:5px 0;border-bottom:1px dotted #999;font-size:18px}
.dish>div:first-child{width:50px;font-weight:bold;text-align:center}
.dish>div:last-child{flex:1;padding-left:10px;line-height:1.4}
.footer{text-align:center;margin-top:15px;padding-top:10px;border-top:2px solid #000;font-size:16px}
</style></head><body>
<div class="header">
<div class="order-num">${orderNumber}</div>
<div class="table-num">${tableInfo}</div>
<div class="kitchen-name">ORDER ${name}</div>
</div>
<div class="col-header"><div>SL</div><div>T√äN M√ìN</div></div>
<div>${dishesHtml}</div>
<div class="footer"><div>Order Time: ${time}</div></div>
</body></html>`;
        }
        
        function fallbackPrint(type) {
            const time = getCurrentTime();
            let dishes = [];
            let name = '';
            
            if (type === 'pho') {
                dishes = allDishes.filter(d => d.kitchenClass === 'pho-item');
                name = 'B·∫æP PH·ªû';
            } else {
                dishes = allDishes.filter(d => d.kitchenClass === 'rice-item');
                name = 'B·∫æP C∆†M';
            }
            
            const dishesHtml = dishes.map(d => `
                <div class="print-dish-item">
                    <div>${d.quantity}</div>
                    <div>${d.name}</div>
                </div>
            `).join('');
            
            document.getElementById('printContent').innerHTML = `
                <div class="print-header">
                    <div class="print-order-num">${orderNumber}</div>
                    <div class="print-table-num">${tableInfo}</div>
                    <div class="print-kitchen-name">ORDER ${name}</div>
                </div>
                <div class="print-dish-header"><div>SL</div><div>T√äN M√ìN</div></div>
                <div>${dishesHtml}</div>
                <div class="print-footer"><div>Order Time: ${time}</div></div>
            `;
            
            window.print();
            showStatus('‚úÖ ƒê√£ g·ª≠i ƒë·∫øn m√°y in th√¥ng th∆∞·ªùng');
        }
        
        function printKitchen(type) {
            currentKitchenType = type;
            const printerInfo = PRINTER_CONFIG[type];
            
            if (!printerInfo) {
                showStatus('‚ùå Kh√¥ng t√¨m th·∫•y c·∫•u h√¨nh m√°y in', 'error');
                return;
            }
            
            showStatus(`ƒêang in ƒë·∫øn ${printerInfo.ip}:${printerInfo.port}...`, 'success');
            
            try {
                const html = createPrintHTML(type);
                const json = JSON.stringify([html]);
                const compressed = pako.gzip(json);
                const base64 = btoa(String.fromCharCode.apply(null, compressed));
                
                // Th√™m th√¥ng tin IP v√† Port v√†o Intent
                const intentUrl = `intent://#Intent;scheme=print-intent;S.content=${base64};S.printer_ip=${printerInfo.ip};S.printer_port=${printerInfo.port};end`;
                
                showStatus(`‚úÖ G·ª≠i ƒë·∫øn m√°y in ${type === 'pho' ? 'PH·ªû' : 'C∆†M'} (${printerInfo.ip})`, 'success');
                
                intentTimeout = setTimeout(() => showModal(), 3000);
                window.addEventListener('blur', () => {
                    if (intentTimeout) clearTimeout(intentTimeout);
                }, { once: true });
                
                setTimeout(() => window.location.href = intentUrl, 500);
                
            } catch (e) {
                showStatus('‚ùå L·ªói: ' + e.message, 'error');
                setTimeout(() => showModal(), 1000);
            }
        }
        
        function getCurrentTime() {
            const now = new Date();
            return now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
        }
        
        function init() {
            const table = getUrlParameter('table');
            if (table) {
                tableInfo = `B√ÄN ${table}`;
                document.getElementById('tableInfo').textContent = tableInfo;
            }
            
            const order = getUrlParameter('order');
            if (order) {
                orderNumber = `#${order}`;
                document.getElementById('orderNumber').textContent = orderNumber;
            }
            
            document.getElementById('orderInfo').textContent = `Order Time: ${getCurrentTime()}`;
            
            const dishes = parseDishesFromUrl();
            if (dishes && dishes.length > 0) {
                allDishes = dishes;
                hasPho = dishes.some(d => d.kitchenClass === 'pho-item');
                hasRice = dishes.some(d => d.kitchenClass === 'rice-item');
            } else {
                allDishes = [
                    { quantity: '2', name: 'Ph·ªü b√≤ t√°i ch√≠n', kitchenType: 'B·∫æP PH·ªû', kitchenClass: 'pho-item' },
                    { quantity: '1', name: 'Ph·ªü g√†', kitchenType: 'B·∫æP PH·ªû', kitchenClass: 'pho-item' },
                    { quantity: '1', name: 'C∆°m rang b√≤', kitchenType: 'B·∫æP C∆†M', kitchenClass: 'rice-item' },
                    { quantity: '2', name: 'C∆°m rang th·∫≠p c·∫©m', kitchenType: 'B·∫æP C∆†M', kitchenClass: 'rice-item' }
                ];
                hasPho = true;
                hasRice = true;
                orderNumber = '#0902-04-02';
                tableInfo = 'B√ÄN 1';
            }
            
            showAllDishes();
            createPrintButtons();
        }
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
