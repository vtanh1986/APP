<!DOCTYPE html>
<html lang='vi'>
<head>
<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0'>
<title>IN TAG GIÁ SÀN GỖ</title>
<style>
    @page { size: A4 portrait; margin: 0; }
    body { width: 210mm; margin: 0; padding: 10mm; box-sizing: border-box; font-family: 'Times New Roman', serif; font-size: 7.5pt; }
    .container { display: flex; flex-direction: row; width: 100%; height: 50mm; border: 1px solid #ccc; page-break-inside: avoid; }
    .column { display: flex; flex-direction: column; justify-content: space-around; padding: 5px; box-sizing: border-box; border-right: 1px solid #ccc; position: relative; }
    .column-1, .column-3 { width: 22mm; }
    .column-2, .column-4 { width: 56mm; }
    .column-2 { border-right: 2px solid #000; }
    .column-4 { border-right: 2px solid #000; }
    .bold { font-weight: bold; }
    .row { display: flex; align-items: center; height: 6.25mm; border-bottom: 1px solid #ccc; padding: 0 5px; box-sizing: border-box; }
    .row:last-child { border-bottom: none; }
    .qrcode { position: absolute; bottom: 4px; right: 4px; width: 12mm; height: 12mm; background-color: #f0f0f0; display: flex; align-items: center; justify-content: center; }
    .qrcode img { width: 100%; height: 100%; }
    #input-container { margin-bottom: 10mm; display: none; }
    #productCodesInput { width: 100%; height: 100px; font-family: 'Times New Roman', serif; font-size: 10pt; padding: 5px; box-sizing: border-box; }
    #generateButton { margin-top: 10px; padding: 5px 10px; font-size: 10pt; cursor: pointer; }
    @media print { #input-container { display: none !important; } }
    .loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; color: white; font-size: 20px; display: none; }
    .loading.show { display: flex; }
    .strikethrough { text-decoration: line-through; }
    .discounted-price { font-weight: bold; font-size: 8.5pt; color: #d00; }
    #password-protection { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 2000; flex-direction: column; color: white; }
    #password-form { background: white; padding: 20px; border-radius: 5px; color: black; text-align: center; }
    #password-form input { margin: 10px 0; padding: 8px; width: 200px; display: block; }
    #password-form button { padding: 8px 15px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%; }
    .error-message { color: red; margin-top: 10px; display: none; }
    .invalid-message { color: red; font-size: 8pt; text-align: center; margin-top: 5px; padding: 5px; background-color: #ffe6e6; border-radius: 3px; }
    .empty-container { height: 50mm; display: flex; align-items: center; justify-content: center; color: #999; font-style: italic; border: 1px dashed #ccc; margin-bottom: 10px; }
    .brand-container { display: flex; justify-content: space-between; width: 100%; }
    .brand-name { flex: 1; }
    .price-policy { margin-left: 10px; font-weight: bold; white-space: nowrap; }
</style>
</head>
<body>
<div id="password-protection">
    <div id="password-form">
        <h2>Vui lòng nhập mật khẩu</h2>
        <input type="password" id="password-input" placeholder="Nhập mật khẩu">
        <button id="password-submit">Xác nhận</button>
        <div id="password-error" class="error-message">Mật khẩu không đúng.</div>
    </div>
</div>

<div id='input-container'>
    <textarea id='productCodesInput' placeholder='Nhập các MÃ HÀNG vào đây, mỗi mã một dòng...'></textarea>
    <button id='generateButton'>Tạo bản in tag giá</button>
</div>

<div id='content'></div>
<div id='loading' class='loading'>Đang tải dữ liệu...</div>

<script>
const CORRECT_PASSWORD = "ritavo123";
const SESSION_DURATION = 30*60*1000;
let inactivityTimer;

document.getElementById('password-submit').onclick = checkPassword;
document.getElementById('password-input').addEventListener('keypress',e=>{
    if(e.key==='Enter') checkPassword();
});

function checkPassword(){
    if(document.getElementById('password-input').value.trim()===CORRECT_PASSWORD){
        sessionStorage.setItem('authenticated','true');
        document.getElementById('password-protection').style.display='none';
        document.getElementById('input-container').style.display='block';
        resetInactivityTimer();
    }else{
        document.getElementById('password-error').style.display='block';
    }
}

function resetInactivityTimer(){
    clearTimeout(inactivityTimer);
    inactivityTimer=setTimeout(()=>{sessionStorage.removeItem('authenticated');location.reload();},SESSION_DURATION);
}
['mousemove','keypress','click','scroll'].forEach(ev=>window.addEventListener(ev,resetInactivityTimer));

document.addEventListener('DOMContentLoaded',()=>{
    if(sessionStorage.getItem('authenticated')==='true'){
        document.getElementById('password-protection').style.display='none';
        document.getElementById('input-container').style.display='block';
        resetInactivityTimer();
    }
});

const API_URL='https://script.google.com/macros/s/AKfycbwKhfK8giNfI2vjX2uOpjS_Zqx0zJ2eOle6R87n13v_hibKZ9dgYgzigbdfuRbFC8XE/exec';
const productCache={};
const QR_CACHE_PREFIX='qr_cache_';

async function fetchProductDataBatch(maHangList){
    const normalized=maHangList.map(code=>({original:code,encoded:encodeURIComponent(code)}));
    const uncached=normalized.filter(x=>!productCache[x.original]);

    if(uncached.length>0){
        try{
            const resp=await fetch(`${API_URL}?maHangList=${uncached.map(x=>x.encoded).join(',')}`);
            const data=await resp.json();
            const arr=Array.isArray(data)?data:[data];

            uncached.forEach(({original})=>{
                const found=arr.find(item=>item.maHang===original);
                if(found){
                    const pct=Math.round((parseFloat(found.phanTramGiamGia)||0)*100);
                    let policy='F';
                    if(found.chinhSachGiaBan) policy=found.chinhSachGiaBan.trim().charAt(0).toUpperCase();
                    productCache[original]={...found,maHang:original,isValid:true,displayBrand:{name:found.nhanHieu||'THƯƠNG HIỆU',policy:`${policy}.${pct}`}};
                }else{
                    productCache[original]=createInvalidProduct(original);
                }
            });
        }catch(e){
            console.error(e);
            uncached.forEach(({original})=>productCache[original]=createInvalidProduct(original));
        }
    }
    return normalized.map(({original})=>productCache[original]||createInvalidProduct(original));
}

function createInvalidProduct(maHang){
    return {maHang,isValid:false,displayBrand:{name:'THƯƠNG HIỆU',policy:'F.30'}};
}
function getQRCodeUrl(maHang){
    const key=QR_CACHE_PREFIX+maHang;
    if(localStorage.getItem(key)) return localStorage.getItem(key);
    const url=`https://quickchart.io/qr?text=${encodeURIComponent(maHang)}&size=100&margin=0`;
    try{localStorage.setItem(key,url);}catch{}
    return url;
}
function escapeHtml(s){return s?String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):"";}
function formatPrice(p){if(!p&&p!==0) return '';const n=typeof p==='string'?parseFloat(p.replace(/,/g,'')):p;return isNaN(n)?'':new Intl.NumberFormat('vi-VN').format(n)+' đ';}
function renderBrand(b){return `<div class="brand-container"><div class="brand-name">${escapeHtml(b.name)}</div><div class="price-policy">${escapeHtml(b.policy)}</div></div>`;}
function createContainer(p1,p2){
    let h=`<div class='container'>${renderCols(p1,'column-1','column-2')}${renderCols(p2,'column-3','column-4')}</div>`;
    return h;
}
function renderCols(p,col1,col2){
    if(!p) return `<div class='${col1}'></div><div class='${col2}'></div>`;
    if(!p.isValid) return `<div class='${col1}'></div><div class='${col2}'><div class="invalid-message">Mã ${escapeHtml(p.maHang)} không tồn tại</div></div>`;
    return `<div class='${col1}'>
        <div class='row bold'>Thương hiệu</div>
        <div class='row bold'>Xuất xứ</div>
        <div class='row bold'>Mã sản phẩm</div>
        <div class='row bold'>Tên sản phẩm</div>
        <div class='row bold'>Kích thước (mm)</div>
        <div class='row bold'>Độ giãn nở</div>
        <div class='row bold'>Độ dày</div>
        <div class='row bold'>Giá niêm yết có VAT</div>
    </div>
    <div class='${col2}'>
        <div class='row'>${renderBrand(p.displayBrand)}</div>
        <div class='row'>${escapeHtml(p.xuatXu)}</div>
        <div class='row'>${escapeHtml(p.maSanPham||p.maHang)}</div>
        <div class='row'>${escapeHtml(p.tenHangTiengViet)}</div>
        <div class='row'>${escapeHtml(p.kichThuoc)}</div>
        <div class='row'>${escapeHtml(p.doGianNo)}</div>
        <div class='row'>${escapeHtml(p.doDay)}</div>
        <div class='row'><span class="strikethrough">${formatPrice(p.giaBanNieYetCoVAT)}</span></div>
        <div class='qrcode'><img src='${getQRCodeUrl(p.maSanPham||p.maHang)}'></div>
    </div>`;
}
document.getElementById('generateButton').onclick=async()=>{
    const codes=document.getElementById('productCodesInput').value.split('\n').map(x=>x.trim()).filter(Boolean);
    if(!codes.length){alert('Nhập ít nhất 1 mã hàng');return;}
    document.getElementById('loading').classList.add('show');
    const products=await fetchProductDataBatch(codes);
    const valid=products.filter(x=>x.isValid);
    if(!valid.length){
        document.getElementById('content').innerHTML='<div class="empty-container">Không có mã hợp lệ</div>';
        document.getElementById('loading').classList.remove('show');return;
    }
    let html='';
    for(let i=0;i<valid.length;i+=2) html+=createContainer(valid[i],valid[i+1]);
    document.getElementById('content').innerHTML=html;
    document.getElementById('loading').classList.remove('show');
};
</script>
</body>
</html>
