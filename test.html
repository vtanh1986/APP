<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Customer Data Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <style>
    body { padding: 20px; }
    .filter-section { background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
    .data-table { margin-top: 20px; }
    .filter-label { font-weight: bold; margin-right: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="mb-4">Customer Data Dashboard</h2>
    
    <div class="filter-section">
      <div class="row mb-3">
        <div class="col-md-4">
          <label class="filter-label">Tên NVKD:</label>
          <select id="nvkdFilter" class="form-select">
            <option value="">Tất cả</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="filter-label">Trạng thái liên hệ:</label>
          <select id="statusFilter" class="form-select">
            <option value="">Tất cả</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="filter-label">Tiến độ công trình:</label>
          <select id="progressFilter" class="form-select">
            <option value="">Tất cả</option>
          </select>
        </div>
      </div>
      <button id="filterBtn" class="btn btn-primary">Lọc dữ liệu</button>
      <button id="resetBtn" class="btn btn-secondary ms-2">Reset</button>
    </div>
    
    <div class="data-table">
      <table id="dataTable" class="table table-striped table-bordered" style="width:100%">
        <thead>
          <tr>
            <th>ID KH</th>
            <th>Tên NVKD</th>
            <th>Tên KH</th>
            <th>Tỉnh</th>
            <th>Huyện/TP</th>
            <th>Điện thoại</th>
            <th>Trạng thái liên hệ</th>
            <th>Tiến độ CT</th>
            <th>Ngày update</th>
            <th>Ghi chú</th>
          </tr>
        </thead>
        <tbody>
          <!-- Data will be loaded here -->
        </tbody>
      </table>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
  
  <script>
    $(document).ready(function() {
      var table;
      
      // Load filter options
      google.script.run.withSuccessHandler(function(options) {
        populateSelect('#nvkdFilter', options.nvkdOptions);
        populateSelect('#statusFilter', options.statusOptions);
        populateSelect('#progressFilter', options.progressOptions);
        
        // Initialize DataTable
        loadData();
      }).getFilterOptions();
      
      function populateSelect(selector, options) {
        var select = $(selector);
        options.forEach(function(option) {
          select.append($('<option>', { value: option, text: option }));
        });
      }
      
      function loadData(filters = {}) {
        if (table) {
          table.destroy();
        }
        
        google.script.run.withSuccessHandler(function(data) {
          table = $('#dataTable').DataTable({
            data: data,
            columns: [
              { data: 'idKH' },
              { data: 'tenNVKD' },
              { data: 'tenKH' },
              { data: 'tinh' },
              { data: 'huyenTP' },
              { data: 'dienThoai' },
              { data: 'trangThaiLienHe' },
              { data: 'tienDoCT' },
              { data: 'ngayUpdate' },
              { 
                data: null,
                render: function(data, type, row) {
                  return (row.note1 || '') + '<br>' + (row.note2 || '') + '<br>' + (row.note3 || '');
                }
              }
            ],
            pageLength: 10,
            language: {
              search: "Tìm kiếm:",
              lengthMenu: "Hiển thị _MENU_ bản ghi mỗi trang",
              info: "Hiển thị _START_ đến _END_ của _TOTAL_ bản ghi",
              paginate: {
                first: "Đầu",
                last: "Cuối",
                next: "Tiếp",
                previous: "Trước"
              }
            }
          });
        }).getDataFromSheet();
      }
      
      // Apply filters
      $('#filterBtn').click(function() {
        var filters = {
          nvkd: $('#nvkdFilter').val(),
          status: $('#statusFilter').val(),
          progress: $('#progressFilter').val()
        };
        
        if (table) {
          table.destroy();
        }
        
        google.script.run.withSuccessHandler(function(data) {
          var filteredData = data.filter(function(row) {
            return (
              (filters.nvkd === '' || row.tenNVKD === filters.nvkd) &&
              (filters.status === '' || row.trangThaiLienHe === filters.status) &&
              (filters.progress === '' || row.tienDoCT === filters.progress)
            );
          });
          
          table = $('#dataTable').DataTable({
            data: filteredData,
            columns: [
              { data: 'idKH' },
              { data: 'tenNVKD' },
              { data: 'tenKH' },
              { data: 'tinh' },
              { data: 'huyenTP' },
              { data: 'dienThoai' },
              { data: 'trangThaiLienHe' },
              { data: 'tienDoCT' },
              { data: 'ngayUpdate' },
              { 
                data: null,
                render: function(data, type, row) {
                  return (row.note1 || '') + '<br>' + (row.note2 || '') + '<br>' + (row.note3 || '');
                }
              }
            ],
            pageLength: 10,
            language: {
              search: "Tìm kiếm:",
              lengthMenu: "Hiển thị _MENU_ bản ghi mỗi trang",
              info: "Hiển thị _START_ đến _END_ của _TOTAL_ bản ghi",
              paginate: {
                first: "Đầu",
                last: "Cuối",
                next: "Tiếp",
                previous: "Trước"
              }
            }
          });
        }).getDataFromSheet();
      });
      
      // Reset filters
      $('#resetBtn').click(function() {
        $('#nvkdFilter, #statusFilter, #progressFilter').val('');
        if (table) {
          table.destroy();
        }
        loadData();
      });
    });
  </script>
</body>
</html>
