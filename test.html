<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý công trình - Bộ lọc nâng cao</title>
    <!-- Thêm thư viện cần thiết -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1a73e8;
            text-align: center;
            margin-bottom: 20px;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }
        .filter-label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .filter-select, .filter-input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #1a73e8;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            height: fit-content;
            align-self: flex-end;
        }
        button:hover {
            background-color: #0d62c9;
        }
        .reset-filter {
            background-color: #f44336;
        }
        .reset-filter:hover {
            background-color: #d32f2f;
        }
        .export-excel {
            background-color: #2e7d32;
        }
        .export-excel:hover {
            background-color: #1b5e20;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            cursor: pointer;
            position: relative;
        }
        th:hover {
            background-color: #e6e6e6;
        }
        th.sort-asc::after {
            content: " ↑";
            color: #1a73e8;
        }
        th.sort-desc::after {
            content: " ↓";
            color: #1a73e8;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #f1f1f1;
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #666;
        }
        .error {
            color: #d32f2f;
            font-weight: bold;
            padding: 20px;
            text-align: center;
        }
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 5px;
        }
        .pagination button {
            margin: 0;
        }
        .image-cell img {
            max-width: 100px;
            max-height: 100px;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.2s;
            object-fit: cover;
        }
        .image-cell img:hover {
            transform: scale(1.5);
            z-index: 100;
            position: relative;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }
        .image-preview {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .image-preview img {
            max-width: 90%;
            max-height: 90%;
        }
        .close-preview {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 30px;
            cursor: pointer;
        }
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 5px;
        }
        .image-grid img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>QUẢN LÝ CÔNG TRÌNH - BỘ LỌC NÂNG CAO</h1>
        
        <div class="controls">
            <div class="filter-group">
                <label class="filter-label">Tên NVKD:</label>
                <select id="tenNVKDFilter" class="filter-select">
                    <option value="">-- Tất cả --</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Trạng thái liên hệ:</label>
                <select id="trangThaiLienHeFilter" class="filter-select">
                    <option value="">-- Tất cả --</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Tiến độ CT:</label>
                <select id="tienDoCTFilter" class="filter-select">
                    <option value="">-- Tất cả --</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Tên KĐT:</label>
                <select id="tenKDTFilter" class="filter-select">
                    <option value="">-- Tất cả --</option>
                </select>
            </div>
            
            <button id="refreshBtn">Làm mới</button>
            <button id="resetFilter" class="reset-filter">Xóa lọc</button>
            <button id="exportExcel" class="export-excel">Xuất Excel</button>
        </div>
        
        <div id="dataContainer">
            <p class="loading">Đang tải dữ liệu...</p>
        </div>
        
        <div class="pagination" id="pagination"></div>
    </div>

    <div id="imagePreviewModal" class="image-preview" style="display: none;">
        <span class="close-preview">&times;</span>
        <img id="previewImage" src="" alt="Xem trước hình ảnh">
    </div>

    <script>
        const apiUrl = 'https://script.google.com/macros/s/AKfycbxsCiGANq8qAwOLDKe8NXrE0o18vMK9aOvQetBJoiks12xMpLFbfpMaIh-KFpMSzMzn/exec';
        const dataContainer = document.getElementById('dataContainer');
        const refreshBtn = document.getElementById('refreshBtn');
        const resetFilterBtn = document.getElementById('resetFilter');
        const exportExcelBtn = document.getElementById('exportExcel');
        const paginationDiv = document.getElementById('pagination');
        
        // Các bộ lọc
        const tenNVKDFilter = document.getElementById('tenNVKDFilter');
        const trangThaiLienHeFilter = document.getElementById('trangThaiLienHeFilter');
        const tienDoCTFilter = document.getElementById('tienDoCTFilter');
        const tenKDTFilter = document.getElementById('tenKDTFilter');
        
        // Modal xem ảnh
        const imagePreviewModal = document.getElementById('imagePreviewModal');
        const previewImage = document.getElementById('previewImage');
        const closePreview = document.querySelector('.close-preview');
        
        let allData = [];
        let currentData = [];
        let currentPage = 1;
        const rowsPerPage = 10;
        let sortColumn = null;
        let sortDirection = 'asc';

        // Danh sách các cột cần ẩn
        const hiddenColumns = ['idKH', 'nvkd', 'chucVu', 'nhom', 'duongDanAnh', 'lichSuTienDoCongTrinh'];

        // Hàm fetch dữ liệu từ API
        async function fetchData() {
            try {
                dataContainer.innerHTML = '<p class="loading">Đang tải dữ liệu...</p>';
                
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error(`Lỗi HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Kiểm tra nếu dữ liệu là mảng
                if (Array.isArray(data)) {
                    allData = data;
                } else if (typeof data === 'object' && data !== null) {
                    allData = [data];
                } else {
                    allData = [];
                }
                
                // Cập nhật các bộ lọc
                updateFilters();
                
                currentPage = 1;
                filterAndRenderData();
                setupPagination();
                
            } catch (error) {
                dataContainer.innerHTML = `
                    <p class="error">Có lỗi xảy ra khi tải dữ liệu:</p>
                    <pre>${error.message}</pre>
                `;
                console.error('Lỗi khi fetch dữ liệu:', error);
            }
        }

        // Cập nhật tất cả bộ lọc
        function updateFilters() {
            updateFilterOptions('tenNVKD', tenNVKDFilter);
            updateFilterOptions('trangThaiLienHe', trangThaiLienHeFilter);
            updateFilterOptions('tienDoCT', tienDoCTFilter);
            updateFilterOptions('tenKDT', tenKDTFilter);
        }

        // Cập nhật options cho một bộ lọc
        function updateFilterOptions(field, filterElement) {
            const uniqueValues = [...new Set(allData.map(item => item[field]))].filter(Boolean).sort();
            
            filterElement.innerHTML = '<option value="">-- Tất cả --</option>';
            uniqueValues.forEach(value => {
                filterElement.innerHTML += `<option value="${value}">${value}</option>`;
            });
        }

        // Hàm lọc dữ liệu theo các điều kiện
        function filterData() {
            const tenNVKD = tenNVKDFilter.value;
            const trangThaiLienHe = trangThaiLienHeFilter.value;
            const tienDoCT = tienDoCTFilter.value;
            const tenKDT = tenKDTFilter.value;
            
            return allData.filter(row => {
                return (!tenNVKD || row.tenNVKD === tenNVKD) &&
                       (!trangThaiLienHe || row.trangThaiLienHe === trangThaiLienHe) &&
                       (!tienDoCT || row.tienDoCT === tienDoCT) &&
                       (!tenKDT || row.tenKDT === tenKDT);
            });
        }

        // Hàm sắp xếp dữ liệu
        function sortData(data) {
            if (!sortColumn) return data;
            
            return [...data].sort((a, b) => {
                const valA = a[sortColumn];
                const valB = b[sortColumn];
                
                if (valA === valB) return 0;
                
                if (typeof valA === 'string' && typeof valB === 'string') {
                    return sortDirection === 'asc' 
                        ? valA.localeCompare(valB) 
                        : valB.localeCompare(valA);
                }
                
                return sortDirection === 'asc' 
                    ? (valA > valB ? 1 : -1)
                    : (valA < valB ? 1 : -1);
            });
        }

        // Hàm định dạng ngày tháng
        function formatDate(dateString) {
            if (!dateString) return '';
            
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;
            
            return date.toLocaleDateString('vi-VN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // Hàm xử lý hiển thị ảnh
        function renderImages(imageData) {
            if (!imageData) return '';
            
            // Nếu là chuỗi JSON (mảng ảnh)
            try {
                const images = JSON.parse(imageData);
                if (Array.isArray(images) && images.length > 0) {
                    return `<div class="image-grid">
                        ${images.map(img => {
                            const imageUrl = img.startsWith('http') ? img : `https://drive.google.com/thumbnail?id=${img}`;
                            return `<img src="${imageUrl}" alt="Ảnh công trình" onclick="showImagePreview('${imageUrl}')">`;
                        }).join('')}
                    </div>`;
                }
            } catch (e) {
                // Nếu không phải JSON, xử lý như ảnh đơn
                const imageUrl = imageData.startsWith('http') ? imageData : `https://drive.google.com/thumbnail?id=${imageData}`;
                return `<img src="${imageUrl}" alt="Ảnh công trình" onclick="showImagePreview('${imageUrl}')" style="max-width:100px;max-height:100px;">`;
            }
            
            return '';
        }

        // Hàm render dữ liệu ra bảng
        function renderTable(data) {
            if (data.length === 0) {
                dataContainer.innerHTML = '<p class="error">Không có dữ liệu phù hợp với điều kiện lọc</p>';
                return;
            }
            
            // Lấy tất cả keys từ các object để làm header, loại bỏ các cột ẩn
            const headers = [...new Set(data.flatMap(item => Object.keys(item)))]
                .filter(header => !hiddenColumns.includes(header));
            
            let html = `<table>
                <thead>
                    <tr>
                        ${headers.map(header => 
                            `<th onclick="sortTable('${header}')" 
                                ${sortColumn === header ? `class="sort-${sortDirection}"` : ''}>
                                ${header}
                            </th>`
                        ).join('')}
                    </tr>
                </thead>
                <tbody>
                    ${data.map(row => `
                        <tr>
                            ${headers.map(header => {
                                let cellValue = row[header] !== undefined ? row[header] : '';
                                
                                // Định dạng ngày tháng cho các trường ngày
                                if (header === 'ngayTiepCan' || header === 'ngayUpdate') {
                                    cellValue = formatDate(cellValue);
                                }
                                
                                // Xử lý hiển thị ảnh cho trường anhCongTrinh
                                if (header === 'anhCongTrinh') {
                                    return `<td class="image-cell">${renderImages(cellValue)}</td>`;
                                }
                                
                                return `<td>${cellValue}</td>`;
                            }).join('')}
                        </tr>
                    `).join('')}
                </tbody>
            </table>`;
            
            dataContainer.innerHTML = html;
        }

        // Hàm xử lý sắp xếp khi click vào header
        window.sortTable = function(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            filterAndRenderData();
        }

        // Hiển thị preview ảnh lớn
        window.showImagePreview = function(imageUrl) {
            previewImage.src = imageUrl;
            imagePreviewModal.style.display = 'flex';
        }

        // Hàm lọc và render dữ liệu
        function filterAndRenderData() {
            let filteredData = filterData();
            filteredData = sortData(filteredData);
            
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            currentData = filteredData.slice(start, end);
            
            renderTable(currentData);
        }

        // Hàm thiết lập phân trang
        function setupPagination() {
            const filteredData = filterData();
            const pageCount = Math.ceil(filteredData.length / rowsPerPage);
            
            let html = '';
            if (pageCount > 1) {
                if (currentPage > 1) {
                    html += `<button onclick="changePage(${currentPage - 1})">Trước</button>`;
                }
                
                // Hiển thị tối đa 5 trang xung quanh trang hiện tại
                const startPage = Math.max(1, currentPage - 2);
                const endPage = Math.min(pageCount, currentPage + 2);
                
                if (startPage > 1) {
                    html += `<button onclick="changePage(1)">1</button>`;
                    if (startPage > 2) html += `<span>...</span>`;
                }
                
                for (let i = startPage; i <= endPage; i++) {
                    html += `<button onclick="changePage(${i})" 
                        ${currentPage === i ? 'style="background-color:#0d62c9"' : ''}>
                        ${i}
                    </button>`;
                }
                
                if (endPage < pageCount) {
                    if (endPage < pageCount - 1) html += `<span>...</span>`;
                    html += `<button onclick="changePage(${pageCount})">${pageCount}</button>`;
                }
                
                if (currentPage < pageCount) {
                    html += `<button onclick="changePage(${currentPage + 1})">Sau</button>`;
                }
            }
            
            paginationDiv.innerHTML = html;
        }

        // Hàm thay đổi trang
        window.changePage = function(page) {
            currentPage = page;
            filterAndRenderData();
            setupPagination();
            window.scrollTo(0, 0);
        }

        // Hàm xuất dữ liệu ra Excel với hình ảnh nhúng
        async function exportToExcel() {
            // Lấy dữ liệu đã lọc (toàn bộ, không phân trang)
            const filteredData = filterData();
            
            if (filteredData.length === 0) {
                alert('Không có dữ liệu để xuất Excel!');
                return;
            }
            
            // Tạo workbook mới
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('Danh sách công trình');
            
            // Lấy tất cả headers, loại bỏ các cột ẩn
            const headers = [...new Set(filteredData.flatMap(item => Object.keys(item)))]
                .filter(header => !hiddenColumns.includes(header));
            
            // Thêm header row
            worksheet.addRow(headers);
            
            // Thêm dữ liệu từng dòng
            for (const row of filteredData) {
                const newRow = worksheet.addRow([]);
                
                headers.forEach((header, colIndex) => {
                    let cellValue = row[header] !== undefined ? row[header] : '';
                    
                    // Định dạng ngày tháng cho các trường ngày
                    if (header === 'ngayTiepCan' || header === 'ngayUpdate') {
                        cellValue = formatDate(cellValue);
                    }
                    
                    const cell = newRow.getCell(colIndex + 1);
                    
                    if (header === 'anhCongTrinh' && cellValue) {
                        // Xử lý hình ảnh - chỉ lấy ảnh đầu tiên nếu có nhiều ảnh
                        let imageUrl = '';
                        try {
                            const images = JSON.parse(cellValue);
                            if (Array.isArray(images) && images.length > 0) {
                                imageUrl = images[0];
                            } else {
                                imageUrl = cellValue;
                            }
                        } catch (e) {
                            imageUrl = cellValue;
                        }
                        
                        imageUrl = imageUrl.startsWith('http') ? imageUrl : `https://drive.google.com/thumbnail?id=${imageUrl}`;
                        
                        // Thêm hình ảnh vào cell
                        (async () => {
                            try {
                                const response = await fetch(imageUrl);
                                const imageBuffer = await response.arrayBuffer();
                                
                                const imageId = workbook.addImage({
                                    buffer: imageBuffer,
                                    extension: 'jpeg',
                                });
                                
                                // Đặt kích thước cho hình ảnh (100x100 pixels)
                                worksheet.addImage(imageId, {
                                    tl: { col: colIndex, row: newRow.number - 1 },
                                    ext: { width: 100, height: 100 },
                                });
                                
                                // Đặt chiều cao cho dòng chứa ảnh
                                worksheet.getRow(newRow.number).height = 80;
                            } catch (error) {
                                console.error('Lỗi khi thêm hình ảnh:', error);
                                cell.value = imageUrl;
                            }
                        })();
                    } else {
                        cell.value = cellValue;
                    }
                });
            }
            
            // Căn chỉnh độ rộng cột tự động
            worksheet.columns.forEach(column => {
                let maxLength = 0;
                column.eachCell({ includeEmpty: true }, cell => {
                    if (cell.value && typeof cell.value === 'string') {
                        maxLength = Math.max(maxLength, cell.value.length);
                    }
                });
                column.width = Math.min(Math.max(maxLength + 2, 10), 50);
            });
            
            // Xuất file Excel
            const buffer = await workbook.xlsx.writeBuffer();
            const fileName = `Danh_sach_cong_trinh_${new Date().toISOString().slice(0, 10)}.xlsx`;
            
            saveAs(new Blob([buffer]), fileName);
        }

        // Gọi hàm fetchData khi trang load
        document.addEventListener('DOMContentLoaded', fetchData);
        
        // Thêm sự kiện click cho nút refresh
        refreshBtn.addEventListener('click', fetchData);
        
        // Thêm sự kiện cho các bộ lọc
        [tenNVKDFilter, trangThaiLienHeFilter, tienDoCTFilter, tenKDTFilter].forEach(filter => {
            filter.addEventListener('change', () => {
                currentPage = 1;
                filterAndRenderData();
                setupPagination();
            });
        });
        
        // Thêm sự kiện cho nút xóa lọc
        resetFilterBtn.addEventListener('click', () => {
            tenNVKDFilter.value = "";
            trangThaiLienHeFilter.value = "";
            tienDoCTFilter.value = "";
            tenKDTFilter.value = "";
            currentPage = 1;
            filterAndRenderData();
            setupPagination();
        });
        
        // Thêm sự kiện cho nút xuất Excel
        exportExcelBtn.addEventListener('click', exportToExcel);
        
        // Đóng modal xem ảnh
        closePreview.addEventListener('click', () => {
            imagePreviewModal.style.display = 'none';
        });
        
        // Đóng modal khi click bên ngoài ảnh
        imagePreviewModal.addEventListener('click', (e) => {
            if (e.target === imagePreviewModal) {
                imagePreviewModal.style.display = 'none';
            }
        });
    </script>
</body>
</html>
