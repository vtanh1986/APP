<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>AppSheet API - Hiển thị có truyền biến</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    th { background: #f2f2f2; }
  </style>
</head>
<body>
  <h2>Hiển thị dữ liệu qua AppSheet API</h2>

  <div id="status">Đang tải...</div>
  <table id="dataTable" style="display:none">
    <thead>
      <tr id="tableHeader"></tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

<script>
async function loadData() {
  const params = new URLSearchParams(window.location.search);
  const filterFrom = params.get('from');
  const filterTo = params.get('to');

  const url = "https://api.appsheet.com/api/v2/apps/95e21b2c-a592-437c-aa46-6747be0a9707/tables/cuocgoi/Action?applicationAccessKey=yHJ2v2HSgdzQQv0SaJZ9RPXoFNCNxjQVphP4p97q4JktO4FYQIxpkVGTmIjPc8qi";

  const reqBody = {
    Action: "Find",
    Properties: {
      Selector: ``
    }
  };

  try {
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(reqBody)
    });

    const text = await res.text();
    if (!text) throw new Error("Rỗng JSON");
    const data = JSON.parse(text);

    let rows = data.Rows || [];

    // Lọc theo khoảng ngày
    if (filterFrom || filterTo) {
      rows = rows.filter(r => {
        const ngay = r["NGAYGOI"] || r["NGAY"] || "";
        const d = new Date(ngay);

        if (filterFrom && d < new Date(filterFrom)) return false;
        if (filterTo && d > new Date(filterTo)) return false;
        return true;
      });
    }

    document.getElementById("status").innerText = "Tổng dòng: " + rows.length;

    if (rows.length === 0) return;

    const headerRow = document.getElementById("tableHeader");
    const body = document.getElementById("tableBody");

    Object.keys(rows[0]).forEach(col => {
      const th = document.createElement("th");
      th.innerText = col;
      headerRow.appendChild(th);
    });

    rows.forEach(r => {
      const tr = document.createElement("tr");
      Object.values(r).forEach(val => {
        const td = document.createElement("td");
        td.innerText = val;
        tr.appendChild(td);
      });
      body.appendChild(tr);
    });

    document.getElementById("dataTable").style.display = "table";

  } catch (err) {
    document.getElementById("status").innerText = "Lỗi: " + err.message;
  }
}

loadData();
</script>
</body>
</html>
