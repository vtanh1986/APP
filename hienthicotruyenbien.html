<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>AppSheet API - Lọc ngày</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #f0f0f0; }
    #loading { font-size: 18px; color: #555; margin-bottom: 10px; }
  </style>
</head>

<body>

<h2>Hiển thị dữ liệu AppSheet (chọn cột)</h2>

<div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
  <label>Từ ngày:</label>
  <input type="date" id="fromDate">

  <label>Đến ngày:</label>
  <input type="date" id="toDate">

  <button id="filterBtn" style="padding: 6px 12px; cursor:pointer;">
    Lọc dữ liệu
  </button>
</div>

<div id="loading">Đang tải dữ liệu...</div>

<table id="dataTable" style="display:none;">
  <thead id="thead"></thead>
  <tbody id="tbody"></tbody>
</table>

<script>
// Chuyển dd/mm/yyyy → Date object
function toDateObject(str) {
  if (!str) return null;
  const [day, month, year] = str.split("/");
  return new Date(`${year}-${month}-${day}`);
}

document.getElementById("filterBtn").addEventListener("click", loadData);

async function loadData() {

  const fromInput = document.getElementById("fromDate").value;
  const toInput   = document.getElementById("toDate").value;

  const from = fromInput ? new Date(fromInput) : null;
  const to   = toInput ? new Date(toInput) : null;

  document.getElementById("loading").innerText = "Đang tải dữ liệu...";

  const url = "https://api.appsheet.com/api/v2/apps/09960054-a6f1-4b69-a252-b813ca3d8b3c/tables/THANH%20TOAN/find";
  const key = "V2-NnuYn-V6SPQ-VURvK-8meBu-hOmsl-3Ux7X-YlOzG-iMEOr";

  const res = await fetch(url, {
    method: "POST",
    headers: {
      "ApplicationAccessKey": key,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ "Action": "Find" }) // không dùng filter nữa
  });

  const raw = await res.json();
  const rows = raw.Rows ?? raw;

  // LỌC NGÀY BẰNG JS
  const filtered = rows.filter(r => {
    const d = toDateObject(r["NGAY XUAT HOA DON"]);
    if (!d) return false;

    return (!from || d >= from) && (!to || d <= to);
  });

  // Hiển thị bảng
  const columns = ["KY HIEU HD", "SO HOA DON", "NGAY XUAT HOA DON"];

  document.getElementById("thead").innerHTML =
    "<tr>" + columns.map(c => `<th>${c}</th>`).join("") + "</tr>";

  document.getElementById("tbody").innerHTML =
    filtered.map(row =>
      "<tr>" +
        columns.map(c => `<td>${row[c] ?? ""}</td>`).join("") +
      "</tr>`
    ).join("");

  document.getElementById("dataTable").style.display = "";
  document.getElementById("loading").innerText = `Đã tải (${filtered.length}) dòng`;
}

loadData();
</script>

</body>
</html>
